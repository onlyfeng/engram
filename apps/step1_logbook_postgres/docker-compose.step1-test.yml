# =============================================================================
# Step1 Logbook PostgreSQL - 测试专用 Docker Compose
# =============================================================================
#
# 用途：仅供 CI 测试 / 本地开发测试使用
# 警告：此文件不是主部署入口！
#
# 如需生产或统一栈部署，请使用：
#   - 根目录 `make deploy`
#   - 或 `docker-compose.unified.yml`
#
# CI 使用方式：
#   docker compose -f docker-compose.step1-test.yml up -d postgres
#   ./scripts/ci/run_tests.sh
#
# =============================================================================

version: "3.8"

services:
  postgres:
    image: postgres:16
    container_name: engram_step1_postgres
    environment:
      # PostgreSQL 超级用户配置
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: engram_test
      
      # ============================================================
      # 服务账号密码配置
      # ============================================================
      # Step1 (Engram) 服务账号
      # step1_migrator - 迁移账号（DDL），用于 schema 创建/修改
      # step1_svc      - 运行账号（DML），用于应用读写操作
      STEP1_MIGRATOR_PASSWORD: ${STEP1_MIGRATOR_PASSWORD:-step1_migrator_dev}
      STEP1_SVC_PASSWORD: ${STEP1_SVC_PASSWORD:-step1_svc_dev}
      
      # OpenMemory 服务账号（可选，如需 OpenMemory 集成）
      # openmemory_migrator_login - 迁移账号（DDL）
      # openmemory_svc            - 运行账号（DML）
      OPENMEMORY_MIGRATOR_PASSWORD: ${OPENMEMORY_MIGRATOR_PASSWORD:-openmemory_migrator_dev}
      OPENMEMORY_SVC_PASSWORD: ${OPENMEMORY_SVC_PASSWORD:-openmemory_svc_dev}
    ports:
      - "5432:5432"
    volumes:
      # 可选：持久化数据（注释掉则每次重启清空）
      # - postgres_data:/var/lib/postgresql/data
      # 自动初始化 schema（可选）
      - ./sql:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d engram_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# 可选：持久化卷
# volumes:
#   postgres_data:
