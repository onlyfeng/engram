# Engram

AI 友好的事实账本与记忆管理模块 - 为 AI Agent 提供可审计、可回放的证据链与可演化知识沉淀。

## 特性

- **Gateway（MCP 网关）**: 连接 Cursor IDE 与 OpenMemory，提供策略校验、审计落库、失败降级
- **Logbook（事实账本）**: 基于 PostgreSQL 的结构化事件日志，支持 SCM 同步、证据链追溯
- **多项目/多用户**: 支持团队空间与私有空间隔离，每项目独立数据库
- **AI 友好**: 结构化 JSON 输出，易于 LLM 理解和处理

## 推荐使用方式

**服务端部署 Gateway，客户端通过 MCP 协议连接**

```
┌─────────────────────────────────────────────────────────┐
│  Cursor IDE / MCP Client（多个客户端）                   │
└────────────────────────┬────────────────────────────────┘
                         │ MCP JSON-RPC (HTTP)
┌────────────────────────▼────────────────────────────────┐
│  服务器：Gateway + Logbook + OpenMemory                  │
│  - 统一部署，集中管理                                    │
│  - 多项目隔离（PROJECT_KEY）                            │
│  - 多用户支持（actor_user_id + Space）                  │
└─────────────────────────────────────────────────────────┘
```

客户端只需配置 MCP 连接，无需安装 Engram 库。

---

## 快速开始

### 一、服务端部署

#### 1. 环境准备

```bash
# 克隆仓库
git clone https://github.com/onlyfeng/engram.git
cd engram

# Python 环境（推荐：venv）
python3 -m venv .venv
# 激活虚拟环境（二选一）：
source .venv/bin/activate   # Linux/macOS/WSL
# .\.venv\Scripts\Activate.ps1   # Windows PowerShell

# 安装依赖（服务端部署建议 full）
make install-full
# Windows 无 make 时可直接执行：
# pip install -e ".[full]"
```

#### 2. 一键初始化数据库

```bash
# 初始化数据库（需要 PostgreSQL 18+ 已安装）
# - 交互终端：会检测 4 个服务账号密码环境变量，并询问是否重设/切换部署模式（logbook-only / unified-stack）
# - 无 TTY（CI/脚本）：不会询问，按当前环境变量直接执行（不完整会报错）
make setup-db

# Linux/WSL2 常见：使用 postgres 账号执行管理员操作（peer auth / unix socket）
DB_ADMIN_PREFIX="sudo -u postgres" make setup-db
```

**Windows 无 make 时**：请使用 WSL 执行上述命令，或参考 [安装指南](docs/installation.md) 中的 Windows 与分步操作（db-create → bootstrap-roles → migrate-ddl → apply-roles → apply-openmemory-grants → verify-permissions）。

> 详细安装（PostgreSQL、pgvector、多平台）请参考 [安装指南](docs/installation.md)

#### 3. 启动服务

> 注意：`make install-full` 只安装 Engram 依赖；`make gateway` **只启动 Gateway**，不会自动安装/拉起 OpenMemory。  
> - **Docker Compose 统一栈**：OpenMemory 会随 `docker compose -f docker-compose.unified.yml up -d --build` 一起启动  
> - **原生部署（非 Docker）**：请先在**另一个终端**启动 OpenMemory（`opm serve`），再启动 Gateway（详见 `docs/installation.md` / `docs/gateway/01_openmemory_deploy_windows.md`）

```bash
# （原生部署）先启动 OpenMemory（新终端）
# - 安装/编译 opm：见 docs/installation.md 的 “安装 OpenMemory”
# - 首次启动需要建表：可临时切换到 migrator 登录（不写 .env）
#   eval "$(make --no-print-directory env-openmemory-first-run)"
#   Windows PowerShell 见 docs/installation.md 的等价用法
# - 若遇权限错误：先执行 make openmemory-grant-svc-full 再重启 opm serve
# eval "$(make --no-print-directory env-shell)"
# opm serve

# 设置环境变量
# 推荐：如果你在 setup-db 时选择写入 .env.local，可直接加载（不会自动写入当前 shell）
set -a; [ -f .env.local ] && . ./.env.local; set +a
# 或：不想手写 source 片段时可用（不打印任何密钥/密码）
# eval "$(make --no-print-directory env-shell)"
# 或：一键加载 .env/.env.local（进入 engram 目录）
# source scripts/ops/load_env_local.sh
# Windows PowerShell: .\scripts\windows\load_env_local.ps1

# 或手动设置（把 <pwd> 换成你的密码）
export POSTGRES_DSN="postgresql://logbook_svc:<pwd>@localhost:5432/engram"
export OPENMEMORY_BASE_URL="http://localhost:8080"
export PROJECT_KEY="default"  # 项目标识（可自定义；建议与项目/数据库名一致）

# 启动 Gateway
make gateway

# （新终端，可选）验证：
# make mcp-doctor    # 仅验证 Gateway MCP（不依赖 OpenMemory）
# make stack-doctor  # 全栈验证（OpenMemory health + memory_store 写入）
# STACK_DOCTOR_FULL=1 make stack-doctor  # 全功能验证（含 evidence/artifacts/logbook）
```

**Windows PowerShell 无 make 时**：环境变量用 `$env:VAR="值"` 设置；若有 `.env.local` 可逐行执行其中的赋值，或先设再启动：
```powershell
$env:POSTGRES_DSN="postgresql://logbook_svc:<pwd>@localhost:5432/engram"
$env:OPENMEMORY_BASE_URL="http://localhost:8080"
$env:PROJECT_KEY="default"
uvicorn engram.gateway.main:app --host 0.0.0.0 --port 8787 --reload
# 验证（新终端）：python scripts/ops/mcp_doctor.py  或  python scripts/ops/stack_doctor.py
# 全功能验证：python scripts/ops/stack_doctor.py --full
```

服务默认监听 `http://0.0.0.0:8787`（MCP: `/mcp`）。  
**Cursor MCP 只需要连接 Gateway**，不会直连 OpenMemory；因此 OpenMemory **只要对 Gateway 可达即可**。  
- **WSL2 场景**：如果你想在 Windows 浏览器打开 OpenMemory Dashboard/API，优先访问 `http://localhost:8080`；若不通，改用 `http://<wsl-ip>:8080`（在 WSL2 内 `hostname -I` 查看），或按 `docs/gateway/01_openmemory_deploy_windows.md` 的 “B.9” 做端口转发。

> 常见提示：
> - `opm serve` 报 `permission denied for schema openmemory`：可先用 `eval "$(make --no-print-directory env-openmemory-first-run)"` 临时切到 migrator 登录，或执行 `make openmemory-grant-svc-full` 再重启 OpenMemory（Windows PowerShell 等价用法见 [安装指南](docs/installation.md) / [Gateway Windows 部署](docs/gateway/01_openmemory_deploy_windows.md)）
> - `opm serve` 警告 `OM_TIER not set`：可在 `.env.local` 设置 `OM_TIER="hybrid"`（或 fast/smart/deep）

### 二、客户端配置

在 Cursor IDE 的 MCP 配置中添加（参考 `configs/mcp/.mcp.json.example`）：

**MCP 配置 SSOT**：`configs/mcp/.mcp.json.example`；README 片段由 `scripts/docs/render_mcp_config_snippet.py` 生成，更新用 `make update-mcp-config-docs`，校验用 `make check-mcp-config-docs-sync`。

<!-- BEGIN GENERATED: mcp_config_snippet -->
<!-- AUTO-GENERATED BY render_mcp_config_snippet.py; DO NOT EDIT -->

```json
{
  "mcpServers": {
    "engram": {
      "type": "http",
      "url": "http://127.0.0.1:8787/mcp"
    }
  }
}
```
<!-- END GENERATED -->

> 说明：
> - 如果 Cursor 不在运行 Gateway 的同一台机器上，请把 `url` 里的 `127.0.0.1` 替换成 **Gateway 所在机器的 IP/域名**（例如 `http://192.168.1.100:8787/mcp`）
> - 若 Gateway 跑在 Windows 的 WSL2 中并希望局域网其它机器可访问，请参考 `docs/gateway/01_openmemory_deploy_windows.md` 的 “B.9 Windows / 局域网访问说明”

配置完成后，AI Agent 即可使用记忆管理功能。

---

## 多项目 / 多用户

### 项目隔离

通过 `PROJECT_KEY` 区分不同项目，每个项目使用独立数据库：

```bash
# 部署项目 A
PROJECT_KEY=proj_a POSTGRES_DB=proj_a make gateway

# 部署项目 B（另一个实例）
PROJECT_KEY=proj_b POSTGRES_DB=proj_b GATEWAY_PORT=8788 make gateway
```

**Windows PowerShell**：先设置环境变量再启动，例如 `$env:PROJECT_KEY="proj_a"; $env:POSTGRES_DB="proj_a"; uvicorn engram.gateway.main:app --host 0.0.0.0 --port 8787 --reload`。

新增一个项目（推荐流程：每项目一库 + 独立实例）：

```bash
# 1) 初始化该项目的数据库/角色/权限（建议让 PROJECT_KEY 与 POSTGRES_DB 保持一致）
PROJECT_KEY=proj_c POSTGRES_DB=proj_c make setup-db

# 2) 为该项目写一份独立 env 文件（避免覆盖当前 .env.local）
ENV_LOCAL_FILE=.env.local.proj_c PROJECT_KEY=proj_c POSTGRES_DB=proj_c make env-write-local

# 3) 启动该项目的 OpenMemory（建议使用不同端口）
set -a; . ./.env.local.proj_c; set +a
OM_PORT=8081 opm serve

# 4) 启动该项目的 Gateway（指向对应的 OpenMemory）
set -a; . ./.env.local.proj_c; set +a
GATEWAY_PORT=8788 OPENMEMORY_BASE_URL=http://localhost:8081 make gateway
```

**Windows PowerShell**：步骤 2 的 `make env-write-local` 可改为 `python scripts/ops/write_env_local.py`（需先设置 `ENV_LOCAL_FILE`、`PROJECT_KEY` 等）。步骤 3/4 中加载 env 改为在 PowerShell 中逐行设置变量后执行 `opm serve` / `uvicorn engram.gateway.main:app --host 0.0.0.0 --port 8788 --reload`。

### 用户隔离（Space 机制）

| 空间类型 | 格式 | 说明 |
|----------|------|------|
| 团队空间 | `team:<project_key>` | 项目成员共享，默认写入目标 |
| 私有空间 | `private:<user_id>` | 用户个人数据 |

MCP 调用时通过 `actor_user_id` 参数标识用户身份。

> 注意：团队空间写入受治理开关控制（`team_write_enabled`），默认可能被降级到私有空间；需通过 `governance_update` 开启并满足证据链策略。身份映射与账号关联参见 [docs/logbook/08_identity_config.md](docs/logbook/08_identity_config.md)。

> 详见 [记忆契约](docs/gateway/03_memory_contract.md) 和 [治理开关](docs/gateway/04_governance_switch.md)

---

## Makefile 快速命令

```bash
make help          # 查看所有命令

# 安装
make install-full  # 安装完整依赖
make install-dev   # 安装开发依赖

# 数据库（一键初始化）
make setup-db      # 一键初始化数据库（自动识别/交互；创建库 + DDL + 角色 + 权限 + 验证）

# 数据库（分步操作）
make db-create              # 创建数据库并启用 pgvector
make bootstrap-roles        # 初始化服务账号
make migrate-ddl            # 仅执行 DDL 迁移（Schema/表/索引）
make apply-roles            # 应用 Logbook 角色和权限
make apply-openmemory-grants # 应用 OpenMemory 权限
make verify-permissions     # 验证数据库权限配置

# 服务
make gateway       # 启动 Gateway（带热重载）

# 测试
make test          # 运行所有测试
make test-quick    # 快速冒烟测试

# 代码质量
make lint          # 代码检查
make format        # 代码格式化
make ci            # 运行全部 CI 门禁
make check-iteration-docs  # 迭代文档规范检查
```

**Windows 无 make 时常用等价命令**（需先激活 venv 并设置 `POSTGRES_DSN`、`OPENMEMORY_BASE_URL` 等环境变量）：

| make 命令 | Windows PowerShell / 命令行 |
|-----------|-----------------------------|
| `make install-full` | `pip install -e ".[full]"` |
| `make install-dev` | `pip install -e ".[full,dev]"` |
| `make setup-db` | 建议使用 WSL 或参考 [安装指南](docs/installation.md) 分步执行 |
| `make gateway` | `uvicorn engram.gateway.main:app --host 0.0.0.0 --port 8787 --reload` |
| `make mcp-doctor` | `python scripts/ops/mcp_doctor.py` |
| `make stack-doctor` | `python scripts/ops/stack_doctor.py` |
| `make test` | `pytest` |
| `make test-quick` | `pytest tests/acceptance/test_installation.py -v` |

---

## 架构

```
┌─────────────────────────────────────────────────────────┐
│  Cursor IDE / MCP Client                                │
└────────────────────────┬────────────────────────────────┘
                         │ MCP JSON-RPC
┌────────────────────────▼────────────────────────────────┐
│  Gateway (engram.gateway)                               │
│  - 策略校验                                             │
│  - 写入审计                                             │
│  - 失败降级                                             │
└────────────────┬──────────────────┬─────────────────────┘
                 │                  │
    ┌────────────▼──────┐   ┌──────▼────────────┐
    │  Logbook          │   │  OpenMemory       │
    │  (PostgreSQL)     │   │  (语义记忆服务)   │
    │  - 事实账本       │   │  - 向量检索       │
    │  - 治理设置       │   │  - 记忆存储       │
    │  - Outbox 队列    │   │                   │
    └───────────────────┘   └───────────────────┘
```

---

## 项目结构

```
engram/
├── src/engram/              # 源代码
│   ├── gateway/             # Gateway 模块（MCP 网关）
│   └── logbook/             # Logbook 模块（事实账本）
├── sql/                     # 数据库迁移脚本
├── configs/mcp/             # MCP 配置示例
├── docs/                    # 文档
├── tests/                   # 测试
├── Makefile                 # 快速命令
└── pyproject.toml           # 项目配置
```

---

## 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `POSTGRES_DSN` | PostgreSQL 连接字符串 | - |
| `PROJECT_KEY` | 项目标识（多项目隔离） | `default` |
| `OPENMEMORY_BASE_URL` | OpenMemory 服务地址 | - |
| `GATEWAY_PORT` | Gateway 端口 | `8787` |

> 完整变量列表见 [环境变量参考](docs/reference/environment_variables.md)

---

## 文档索引

| 文档 | 说明 |
|------|------|
| [安装指南](docs/installation.md) | 详细安装步骤（多平台、PostgreSQL、pgvector） |
| [Gateway 文档](docs/gateway/) | MCP 集成、治理开关、降级策略 |
| [Logbook 文档](docs/logbook/) | 架构设计、工具契约、部署运维 |
| [环境变量参考](docs/reference/environment_variables.md) | 所有环境变量说明 |
| [架构文档](docs/architecture/) | 架构决策记录（ADR）、命名规范 |
| [迭代文档 SSOT（验收矩阵）](docs/acceptance/00_acceptance_matrix.md) | 迭代计划/回归/证据索引（SSOT） |
| [迭代本地草稿工作流](docs/dev/iteration_local_drafts.md) | `.iteration/` 草稿与晋升规则 |

---

## 其他使用方式

### 作为 Python 库使用

如需在自己的项目中编程式调用 Logbook：

```bash
pip install engram
```

```python
from engram.logbook import Database, Config

config = Config.from_env()
db = Database(config.postgres_dsn)

# 创建条目
item_id = db.create_item(
    item_type="task",
    title="My Task",
    project_key="my_project"
)

# 添加事件
db.add_event(item_id, event_type="progress", payload={"status": "done"})
```

### CLI 命令

```bash
engram-logbook health              # 健康检查
engram-logbook create_item ...     # 创建条目
engram-artifacts --help            # Artifact CLI
engram-migrate --help              # 数据库迁移 CLI
engram-bootstrap-roles --help      # 初始化服务账号
engram-gateway                     # 启动 Gateway
engram-iteration rerun-advice --help  # 迭代工具入口
```

### SCM 同步工具

SCM 同步子系统提供以下 CLI 工具：

```bash
# 调度器 - 扫描仓库并入队同步任务
engram-scm-scheduler --once              # 执行一次调度
engram-scm-scheduler --once --dry-run    # 干运行（不实际入队）
engram-scm-scheduler --loop              # 循环模式运行

# Worker - 从队列处理同步任务
engram-scm-worker --worker-id worker-1          # 启动 worker
engram-scm-worker --worker-id worker-1 --once   # 处理单个任务

# Reaper - 回收过期任务和锁
engram-scm-reaper --once                 # 执行一次清理
engram-scm-reaper --loop                 # 循环模式运行

# 状态查看 - 查看同步健康状态
engram-scm-status --json                 # JSON 格式输出
engram-scm-status --prometheus           # Prometheus 指标格式

# 运行器 - 手动执行同步（通过 engram-scm-sync）
engram-scm-sync runner incremental --repo gitlab:123
engram-scm-sync runner backfill --repo gitlab:123 --last-hours 24

# 管理操作（通过 engram-scm-sync admin）
engram-scm-sync admin jobs list --status dead    # 查看 dead 任务
engram-scm-sync admin jobs reset-dead            # 重置 dead 任务
engram-scm-sync admin locks list-expired         # 查看过期锁
```

> **弃用说明**: 根目录的 `python scm_sync_*.py` 脚本已移除，请使用 `engram-scm-*` 命令。

> 详细配置参见 [SCM Sync 运维指南](docs/logbook/07_scm_sync_ops_guide.md) 和 [环境变量参考](docs/reference/environment_variables.md#scm-同步服务)
> 
> 仅通过 MCP 的客户端可使用 `scm_patch_blob_resolve` / `scm_materialize_patch_blob` 获取 patch 证据，编排示例见 [docs/gateway/08_workflow_orchestration_template.md](docs/gateway/08_workflow_orchestration_template.md)。

---

## 许可证

MIT License
