{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/object_store_audit_event_v2.schema.json",
  "title": "Object Store Audit Event V2 Schema",
  "description": "对象存储审计事件的归一化结构 JSON Schema (V2)，支持 MinIO/AWS S3/GCS 等多种对象存储提供者的审计日志归一化",

  "definitions": {
    "iso8601_datetime": {
      "type": "string",
      "description": "ISO8601 格式的日期时间字符串",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(Z|[+-]\\d{2}:\\d{2})$"
    },

    "provider_type": {
      "type": "string",
      "description": "对象存储提供者类型",
      "enum": ["minio", "aws", "gcs", "azure_blob", "other"]
    },

    "s3_operation": {
      "type": "string",
      "description": "S3 兼容的操作类型",
      "pattern": "^s3:[A-Za-z]+$",
      "examples": ["s3:GetObject", "s3:PutObject", "s3:DeleteObject", "s3:ListBucket", "s3:HeadObject"]
    }
  },

  "type": "object",
  "description": "对象存储审计事件归一化结构",
  "required": ["schema_version", "provider", "event_ts", "bucket", "operation", "raw"],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema 版本号",
      "pattern": "^\\d+\\.\\d+$",
      "const": "2.0"
    },
    "provider": {
      "$ref": "#/definitions/provider_type",
      "description": "对象存储提供者（minio, aws, gcs, azure_blob, other）"
    },
    "event_ts": {
      "$ref": "#/definitions/iso8601_datetime",
      "description": "事件时间戳（原始事件发生时间，ISO8601 格式）"
    },
    "bucket": {
      "type": "string",
      "description": "存储桶名称",
      "minLength": 1,
      "maxLength": 255
    },
    "object_key": {
      "type": ["string", "null"],
      "description": "对象键（部分操作如 ListBucket 可能为空）",
      "maxLength": 1024
    },
    "operation": {
      "type": "string",
      "description": "操作类型（归一化为 s3:* 格式，如 s3:GetObject, s3:PutObject）",
      "pattern": "^(s3:[A-Za-z]+|unknown)$"
    },
    "status_code": {
      "type": ["integer", "null"],
      "description": "HTTP 状态码",
      "minimum": 100,
      "maximum": 599
    },
    "success": {
      "type": "boolean",
      "description": "操作是否成功（status_code 2xx 为 true）"
    },
    "request_id": {
      "type": ["string", "null"],
      "description": "请求 ID（用于追踪和去重）",
      "maxLength": 256
    },
    "principal": {
      "type": ["string", "null"],
      "description": "操作者标识（IAM 用户/角色/访问密钥）",
      "maxLength": 512
    },
    "remote_ip": {
      "type": ["string", "null"],
      "description": "客户端 IP 地址（IPv4 或 IPv6）",
      "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}$|^([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}$|^$"
    },
    "user_agent": {
      "type": ["string", "null"],
      "description": "客户端 User-Agent",
      "maxLength": 1024
    },
    "bytes_sent": {
      "type": ["integer", "null"],
      "description": "发送的字节数",
      "minimum": 0
    },
    "bytes_received": {
      "type": ["integer", "null"],
      "description": "接收的字节数",
      "minimum": 0
    },
    "duration_ms": {
      "type": ["integer", "null"],
      "description": "请求处理时间（毫秒）",
      "minimum": 0
    },
    "raw": {
      "type": "object",
      "description": "原始审计日志（完整保留，不同 provider 格式不同）",
      "additionalProperties": true
    }
  },

  "examples": [
    {
      "schema_version": "2.0",
      "provider": "minio",
      "event_ts": "2024-01-15T10:00:00.000Z",
      "bucket": "engram-artifacts",
      "object_key": "scm/1/git/commits/abc123.diff",
      "operation": "s3:PutObject",
      "status_code": 200,
      "success": true,
      "request_id": "REQ-123-456",
      "principal": "AKIAIOSFODNN7EXAMPLE",
      "remote_ip": "192.168.1.100",
      "user_agent": "MinIO Console",
      "bytes_sent": 0,
      "bytes_received": 1024,
      "duration_ms": 15,
      "raw": {
        "version": "1",
        "deploymentid": "test-deployment",
        "time": "2024-01-15T10:00:00.000Z",
        "api": {
          "name": "PutObject",
          "bucket": "engram-artifacts",
          "object": "scm/1/git/commits/abc123.diff",
          "statusCode": 200
        }
      }
    },
    {
      "schema_version": "2.0",
      "provider": "aws",
      "event_ts": "2024-01-15T11:30:00.000Z",
      "bucket": "my-bucket",
      "object_key": "data/file.json",
      "operation": "s3:GetObject",
      "status_code": 200,
      "success": true,
      "request_id": "A1B2C3D4E5F67890",
      "principal": "arn:aws:iam::123456789012:user/admin",
      "remote_ip": "203.0.113.45",
      "user_agent": "aws-cli/2.0",
      "bytes_sent": 2048,
      "bytes_received": 0,
      "duration_ms": 45,
      "raw": {
        "eventVersion": "1.08",
        "eventSource": "s3.amazonaws.com",
        "eventName": "GetObject",
        "awsRegion": "us-east-1",
        "requestParameters": {
          "bucketName": "my-bucket",
          "key": "data/file.json"
        }
      }
    },
    {
      "schema_version": "2.0",
      "provider": "minio",
      "event_ts": "2024-01-15T12:00:00.000Z",
      "bucket": "engram",
      "object_key": null,
      "operation": "s3:ListBucket",
      "status_code": 200,
      "success": true,
      "request_id": "REQ-789",
      "principal": null,
      "remote_ip": "10.0.0.1",
      "user_agent": null,
      "bytes_sent": null,
      "bytes_received": null,
      "duration_ms": null,
      "raw": {
        "version": "1",
        "api": {
          "name": "ListBucket",
          "bucket": "engram",
          "statusCode": 200
        }
      }
    }
  ]
}
