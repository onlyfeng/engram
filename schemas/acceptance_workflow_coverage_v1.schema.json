{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/acceptance_workflow_coverage_v1.schema.json",
  "title": "Acceptance Workflow Coverage V1 Schema",
  "description": "Engram 验收工作流覆盖配置 Schema (V1)。定义 acceptance targets 与 CI/Nightly workflow 的覆盖关系、profile 映射及实现方式。",

  "type": "object",
  "required": ["version", "ssot_references", "targets"],
  "additionalProperties": false,

  "definitions": {
    "profile_type": {
      "type": "string",
      "description": "门禁 profile 类型，与 unified_stack_gate_contract.py 对齐",
      "enum": ["http_only", "standard", "full"]
    },

    "step_name": {
      "type": "string",
      "description": "验证步骤名称，与 unified_stack_gate_contract.py::StepName 对齐",
      "enum": [
        "health_checks",
        "db_invariants",
        "memory_store",
        "memory_query",
        "jsonrpc",
        "degradation",
        "audit_gc_smoke",
        "tool_check"
      ]
    },

    "implementation_mode": {
      "type": "string",
      "description": "在 workflow 中的实现方式",
      "enum": ["direct", "composed"]
    },

    "evidence_path": {
      "type": "object",
      "description": "证据产物路径定义",
      "required": ["path", "description"],
      "additionalProperties": false,
      "properties": {
        "path": {
          "type": "string",
          "description": "产物相对路径（相对于 .artifacts/）"
        },
        "description": {
          "type": "string",
          "description": "产物描述"
        },
        "required": {
          "type": "boolean",
          "description": "是否为必需产物",
          "default": true
        }
      }
    },

    "workflow_implementation": {
      "type": "object",
      "description": "workflow 实现配置",
      "required": ["mode", "workflow_file"],
      "additionalProperties": false,
      "properties": {
        "mode": {
          "$ref": "#/definitions/implementation_mode"
        },
        "workflow_file": {
          "type": "string",
          "description": "workflow 文件路径（相对于 .github/workflows/）"
        },
        "job_name": {
          "type": "string",
          "description": "直接执行时的 job 名称（mode=direct 时使用）"
        },
        "makefile_target": {
          "type": "string",
          "description": "直接执行时调用的 Makefile 目标（mode=direct 时使用）"
        },
        "composed_steps": {
          "type": "array",
          "description": "组合式覆盖时的步骤序列（mode=composed 时使用）",
          "items": {
            "type": "object",
            "required": ["name", "description"],
            "additionalProperties": false,
            "properties": {
              "name": {
                "type": "string",
                "description": "步骤名称"
              },
              "description": {
                "type": "string",
                "description": "步骤描述"
              },
              "command": {
                "type": "string",
                "description": "执行的命令或 Makefile 目标"
              },
              "env_overrides": {
                "type": "object",
                "description": "环境变量覆盖",
                "additionalProperties": {
                  "type": "string"
                }
              }
            }
          }
        },
        "depends_on": {
          "type": "array",
          "description": "依赖的前置 job（非 acceptance 步骤本身）",
          "items": {
            "type": "string"
          }
        },
        "notes": {
          "type": "string",
          "description": "实现说明或注意事项"
        }
      }
    },

    "acceptance_target": {
      "type": "object",
      "description": "验收目标定义",
      "required": [
        "name",
        "description",
        "profile",
        "required_steps",
        "required_evidence_paths",
        "ci_implementation",
        "nightly_implementation",
        "environment"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "验收目标名称"
        },
        "description": {
          "type": "string",
          "description": "验收目标描述"
        },
        "profile": {
          "$ref": "#/definitions/profile_type"
        },
        "required_steps": {
          "type": "array",
          "description": "必需的验证步骤（逻辑覆盖点）",
          "items": {
            "$ref": "#/definitions/step_name"
          },
          "minItems": 1
        },
        "optional_steps": {
          "type": "array",
          "description": "可选的验证步骤",
          "items": {
            "$ref": "#/definitions/step_name"
          }
        },
        "required_evidence_paths": {
          "type": "array",
          "description": "必需的证据产物路径",
          "items": {
            "$ref": "#/definitions/evidence_path"
          },
          "minItems": 1
        },
        "ci_implementation": {
          "$ref": "#/definitions/workflow_implementation",
          "description": "CI workflow 中的实现方式"
        },
        "nightly_implementation": {
          "$ref": "#/definitions/workflow_implementation",
          "description": "Nightly workflow 中的实现方式"
        },
        "environment": {
          "type": "object",
          "description": "环境变量语义（固定值）",
          "additionalProperties": {
            "type": "string"
          }
        },
        "capabilities": {
          "type": "array",
          "description": "必需的环境能力",
          "items": {
            "type": "string"
          }
        }
      }
    }
  },

  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema 引用（可选）",
      "format": "uri-reference"
    },

    "version": {
      "type": "string",
      "description": "配置版本号",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },

    "ssot_references": {
      "type": "object",
      "description": "单一来源（SSOT）位置引用",
      "required": ["profile_definitions", "step_definitions", "capability_definitions"],
      "additionalProperties": false,
      "properties": {
        "profile_definitions": {
          "type": "string",
          "description": "Profile 定义的 SSOT 位置"
        },
        "step_definitions": {
          "type": "string",
          "description": "Step 定义的 SSOT 位置"
        },
        "capability_definitions": {
          "type": "string",
          "description": "Capability 定义的 SSOT 位置"
        },
        "acceptance_matrix": {
          "type": "string",
          "description": "验收矩阵文档位置"
        },
        "ci_workflow": {
          "type": "string",
          "description": "CI workflow 文件位置"
        },
        "nightly_workflow": {
          "type": "string",
          "description": "Nightly workflow 文件位置"
        }
      }
    },

    "targets": {
      "type": "object",
      "description": "验收目标定义（key 为目标名称）",
      "additionalProperties": {
        "$ref": "#/definitions/acceptance_target"
      },
      "minProperties": 1
    },

    "profile_mapping": {
      "type": "object",
      "description": "Profile 与 Makefile 目标的映射关系",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "integration_test_target": {
            "type": "string",
            "description": "对应的 make test-gateway-integration 目标"
          },
          "acceptance_target": {
            "type": "string",
            "description": "对应的 make acceptance-* 目标"
          },
          "verify_unified_flags": {
            "type": "string",
            "description": "make verify-unified 时的环境变量"
          }
        }
      }
    }
  },

  "examples": [
    {
      "version": "1.0.0",
      "ssot_references": {
        "profile_definitions": "src/engram/unified_stack/gate_contract.py::PROFILE_CONFIGS",
        "step_definitions": "src/engram/unified_stack/gate_contract.py::StepName",
        "capability_definitions": "src/engram/unified_stack/gate_contract.py::detect_capabilities",
        "acceptance_matrix": "docs/acceptance/00_acceptance_matrix.md",
        "ci_workflow": ".github/workflows/ci.yml",
        "nightly_workflow": ".github/workflows/nightly.yml"
      },
      "targets": {
        "acceptance-unified-min": {
          "name": "acceptance-unified-min",
          "description": "CI PR 快速验证（HTTP 模式）",
          "profile": "http_only",
          "required_steps": ["health_checks", "memory_store", "memory_query"],
          "required_evidence_paths": [
            {"path": "acceptance-unified-min/summary.json", "description": "验收摘要", "required": true}
          ],
          "ci_implementation": {
            "mode": "composed",
            "workflow_file": "ci.yml"
          },
          "nightly_implementation": {
            "mode": "direct",
            "workflow_file": "nightly.yml"
          },
          "environment": {
            "HTTP_ONLY_MODE": "1",
            "SKIP_DEGRADATION_TEST": "1",
            "GATE_PROFILE": "http_only"
          }
        }
      }
    }
  ]
}
