{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/audit_event_v1.schema.json",
  "title": "Audit Event V1 Schema",
  "description": "Engram 审计事件结构 JSON Schema (V1)，覆盖 gateway/audit_event.py 中 build_audit_event() 和 build_evidence_refs_json() 输出结构",

  "definitions": {
    "correlation_id": {
      "type": "string",
      "description": "关联追踪 ID，格式: corr-{16位十六进制}",
      "pattern": "^corr-[a-fA-F0-9]{16}$"
    },

    "sha256": {
      "type": "string",
      "description": "SHA256 哈希值，64位十六进制字符串",
      "pattern": "^[a-fA-F0-9]{64}$"
    },

    "iso8601_datetime": {
      "type": "string",
      "description": "ISO8601 格式的日期时间字符串",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(Z|[+-]\\d{2}:\\d{2})$"
    },

    "decision": {
      "type": "object",
      "description": "决策信息",
      "additionalProperties": false,
      "properties": {
        "action": {
          "type": ["string", "null"],
          "description": "决策动作",
          "enum": ["allow", "redirect", "reject", null]
        },
        "reason": {
          "type": ["string", "null"],
          "description": "决策原因（业务层小写+下划线，校验/依赖层大写+下划线）"
        }
      }
    },

    "evidence_summary": {
      "type": "object",
      "description": "证据摘要信息",
      "required": ["count", "has_strong", "uris"],
      "additionalProperties": false,
      "properties": {
        "count": {
          "type": "integer",
          "description": "证据数量",
          "minimum": 0
        },
        "has_strong": {
          "type": "boolean",
          "description": "是否包含强证据（有 sha256）"
        },
        "uris": {
          "type": "array",
          "description": "URI 列表（最多 5 个）",
          "maxItems": 5,
          "items": {
            "type": "string"
          }
        }
      }
    },

    "trim": {
      "type": "object",
      "description": "裁剪信息",
      "additionalProperties": false,
      "properties": {
        "was_trimmed": {
          "type": "boolean",
          "description": "是否进行了裁剪"
        },
        "why": {
          "type": ["string", "null"],
          "description": "裁剪原因"
        },
        "original_len": {
          "type": ["integer", "null"],
          "description": "裁剪前的原始长度"
        }
      }
    },

    "policy_substructure": {
      "type": "object",
      "description": "v1.1 新增: 策略决策上下文子结构",
      "additionalProperties": false,
      "properties": {
        "mode": {
          "type": ["string", "null"],
          "description": "策略模式",
          "enum": ["strict", "compat", null]
        },
        "mode_reason": {
          "type": ["string", "null"],
          "description": "模式判定说明"
        },
        "policy_version": {
          "type": ["string", "null"],
          "description": "策略版本",
          "enum": ["v1", "v2", null]
        },
        "is_pointerized": {
          "type": "boolean",
          "description": "是否 pointerized（v2 特性）"
        },
        "policy_source": {
          "type": ["string", "null"],
          "description": "策略来源",
          "enum": ["settings", "default", "override", "dedup", null]
        }
      }
    },

    "validation_substructure": {
      "type": "object",
      "description": "v1.1 新增: 校验状态上下文子结构",
      "additionalProperties": false,
      "properties": {
        "validate_refs_effective": {
          "type": ["boolean", "null"],
          "description": "实际生效的 validate_refs 值"
        },
        "validate_refs_reason": {
          "type": ["string", "null"],
          "description": "validate_refs 决策原因"
        },
        "evidence_validation": {
          "type": ["object", "null"],
          "description": "evidence 校验详情",
          "additionalProperties": true,
          "properties": {
            "is_valid": {
              "type": "boolean",
              "description": "校验是否通过"
            },
            "mode": {
              "type": "string",
              "description": "校验模式"
            },
            "error_code": {
              "type": ["string", "null"],
              "description": "错误码"
            },
            "error_codes": {
              "type": "array",
              "description": "细化错误码列表",
              "items": {
                "type": "string"
              }
            },
            "compat_warnings": {
              "type": "array",
              "description": "compat 模式警告（用于可观测）",
              "items": {
                "type": "string"
              }
            },
            "has_evidence": {
              "type": "boolean",
              "description": "是否有证据"
            },
            "evidence_count": {
              "type": "integer",
              "description": "证据数量"
            },
            "failed_field": {
              "type": "string",
              "description": "校验失败的字段"
            },
            "failed_uris": {
              "type": "array",
              "description": "校验失败的 URI 列表",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },

    "pointer_substructure": {
      "type": "object",
      "description": "v1.3 新增: redirect 且 pointerized 时的指针子结构",
      "additionalProperties": false,
      "properties": {
        "from_space": {
          "type": "string",
          "description": "原始请求空间"
        },
        "to_space": {
          "type": "string",
          "description": "最终写入空间"
        },
        "reason": {
          "type": ["string", "null"],
          "description": "redirect 原因"
        },
        "preserved": {
          "type": "boolean",
          "description": "原始引用是否保留"
        }
      },
      "required": ["from_space", "to_space"]
    },

    "audit_event": {
      "type": "object",
      "description": "审计事件主结构（由 build_audit_event/build_gateway_audit_event 等生成）",
      "required": ["schema_version", "source", "operation", "correlation_id", "decision", "evidence_summary", "trim", "refs", "event_ts"],
      "additionalProperties": true,
      "properties": {
        "schema_version": {
          "type": "string",
          "description": "审计事件版本号",
          "pattern": "^\\d+\\.\\d+$"
        },
        "source": {
          "type": "string",
          "description": "事件来源",
          "enum": ["gateway", "outbox_worker", "reconcile_outbox"]
        },
        "operation": {
          "type": "string",
          "description": "操作类型（memory_store/governance_update/outbox_flush 等）"
        },
        "correlation_id": {
          "$ref": "#/definitions/correlation_id"
        },
        "actor_user_id": {
          "type": ["string", "null"],
          "description": "执行操作的用户标识"
        },
        "requested_space": {
          "type": ["string", "null"],
          "description": "原始请求的目标空间"
        },
        "final_space": {
          "type": ["string", "null"],
          "description": "最终写入的空间（可能经过策略重定向）"
        },
        "decision": {
          "$ref": "#/definitions/decision"
        },
        "payload_sha": {
          "type": ["string", "null"],
          "description": "内容 SHA256 哈希"
        },
        "payload_len": {
          "type": ["integer", "null"],
          "description": "内容长度（字符数）",
          "minimum": 0
        },
        "evidence_summary": {
          "$ref": "#/definitions/evidence_summary"
        },
        "trim": {
          "$ref": "#/definitions/trim"
        },
        "refs": {
          "type": "array",
          "description": "兼容旧字段：证据引用列表",
          "items": {
            "type": "string"
          }
        },
        "event_ts": {
          "$ref": "#/definitions/iso8601_datetime"
        },
        "outbox_id": {
          "type": "integer",
          "description": "Outbox 记录 ID（兼容旧字段）"
        },
        "memory_id": {
          "type": "string",
          "description": "OpenMemory 返回的 memory_id（兼容旧字段）"
        },
        "retry_count": {
          "type": "integer",
          "description": "重试次数（兼容旧字段）",
          "minimum": 0
        },
        "next_attempt_at": {
          "type": "string",
          "description": "下次尝试时间（兼容旧字段）"
        },
        "policy_mode": {
          "type": ["string", "null"],
          "description": "策略模式（顶层兼容字段）",
          "enum": ["strict", "compat", null]
        },
        "evidence_validation": {
          "type": ["object", "null"],
          "description": "evidence 校验结果（顶层兼容字段）",
          "additionalProperties": true
        },
        "policy": {
          "$ref": "#/definitions/policy_substructure"
        },
        "validation": {
          "$ref": "#/definitions/validation_substructure"
        },
        "pointer": {
          "$ref": "#/definitions/pointer_substructure"
        },
        "extra": {
          "type": "object",
          "description": "额外的自定义字段",
          "additionalProperties": true
        }
      }
    },

    "patch_item": {
      "type": "object",
      "description": "patches 数组中的单个条目",
      "required": ["artifact_uri", "sha256"],
      "additionalProperties": true,
      "properties": {
        "artifact_uri": {
          "type": "string",
          "description": "Canonical 格式 URI: memory://patch_blobs/<source_type>/<source_id>/<sha256>",
          "pattern": "^memory://patch_blobs/[a-zA-Z0-9_-]+(?:/[a-zA-Z0-9_/:.-]+)?/[a-fA-F0-9]{64}$"
        },
        "sha256": {
          "$ref": "#/definitions/sha256"
        },
        "source_id": {
          "type": "string",
          "description": "来源 ID，格式: <repo_id>:<revision/sha>"
        },
        "source_type": {
          "type": "string",
          "description": "来源类型",
          "enum": ["svn", "git", "mr"]
        },
        "kind": {
          "type": "string",
          "description": "条目类型，默认 patch"
        }
      }
    },

    "attachment_item": {
      "type": "object",
      "description": "attachments 数组中的单个条目",
      "required": ["artifact_uri", "sha256"],
      "additionalProperties": true,
      "properties": {
        "artifact_uri": {
          "type": "string",
          "description": "Canonical 格式 URI: memory://attachments/<attachment_id>/<sha256>，其中 attachment_id 必须为整数（数据库主键），sha256 为 64 位十六进制。禁止使用旧格式 memory://attachments/<namespace>/<id>/<sha256>（三段路径格式已废弃，Logbook 会拒绝解析）",
          "pattern": "^memory://attachments/\\d+/[a-fA-F0-9]{64}$"
        },
        "sha256": {
          "$ref": "#/definitions/sha256"
        },
        "source_id": {
          "type": "string",
          "description": "来源 ID（可选）"
        },
        "source_type": {
          "type": "string",
          "description": "来源类型（可选）"
        },
        "kind": {
          "type": "string",
          "description": "条目类型，默认 attachment"
        }
      }
    },

    "external_item": {
      "type": "object",
      "description": "external 数组中的单个条目（git://, svn://, https:// 等外部 URI）",
      "required": ["uri"],
      "additionalProperties": true,
      "properties": {
        "uri": {
          "type": "string",
          "description": "外部资源 URI"
        },
        "sha256": {
          "type": "string",
          "description": "外部资源 hash（可选，外部资源可能无法获取）"
        },
        "event_id": {
          "type": ["integer", "string"],
          "description": "事件 ID"
        },
        "svn_rev": {
          "type": ["integer", "string"],
          "description": "SVN revision"
        },
        "git_commit": {
          "type": "string",
          "description": "Git commit SHA"
        },
        "mr": {
          "type": ["integer", "string"],
          "description": "Merge Request ID"
        }
      }
    },

    "evidence_refs_json": {
      "type": "object",
      "description": "Logbook 兼容的 evidence_refs_json 结构（由 build_evidence_refs_json 生成）",
      "required": ["gateway_event"],
      "additionalProperties": true,
      "properties": {
        "gateway_event": {
          "$ref": "#/definitions/audit_event"
        },
        "patches": {
          "type": "array",
          "description": "patches 列表（memory://patch_blobs/... URI）",
          "items": {
            "$ref": "#/definitions/patch_item"
          }
        },
        "attachments": {
          "type": "array",
          "description": "attachments 列表（memory://attachments/... URI）",
          "items": {
            "$ref": "#/definitions/attachment_item"
          }
        },
        "external": {
          "type": "array",
          "description": "external 列表（git://, https://, svn:// 等外部 URI）",
          "items": {
            "$ref": "#/definitions/external_item"
          }
        },
        "evidence_summary": {
          "$ref": "#/definitions/evidence_summary"
        }
      }
    }
  },

  "oneOf": [
    {
      "$ref": "#/definitions/audit_event",
      "description": "单独的审计事件（由 build_*_audit_event 函数生成）"
    },
    {
      "$ref": "#/definitions/evidence_refs_json",
      "description": "完整的 evidence_refs_json 结构（由 build_evidence_refs_json 生成）"
    }
  ],

  "examples": [
    {
      "schema_version": "1.1",
      "source": "gateway",
      "operation": "memory_store",
      "correlation_id": "corr-a1b2c3d4e5f67890",
      "actor_user_id": "user1",
      "requested_space": "team:project",
      "final_space": "team:project",
      "decision": {
        "action": "allow",
        "reason": "policy_passed"
      },
      "payload_sha": "abc123def456",
      "payload_len": 1024,
      "evidence_summary": {
        "count": 2,
        "has_strong": true,
        "uris": ["memory://patch_blobs/git/1:abc/sha256hash"]
      },
      "trim": {
        "was_trimmed": false,
        "why": null,
        "original_len": null
      },
      "refs": ["memory://patch_blobs/git/1:abc/sha256hash"],
      "event_ts": "2024-01-15T10:30:00.000000+00:00"
    },
    {
      "schema_version": "1.1",
      "source": "gateway",
      "operation": "memory_store",
      "correlation_id": "corr-1234567890abcdef",
      "actor_user_id": "user2",
      "requested_space": "personal",
      "final_space": "team:fallback",
      "decision": {
        "action": "redirect",
        "reason": "team_write_disabled"
      },
      "payload_sha": null,
      "payload_len": 512,
      "evidence_summary": {
        "count": 0,
        "has_strong": false,
        "uris": []
      },
      "trim": {
        "was_trimmed": false,
        "why": null,
        "original_len": null
      },
      "refs": [],
      "event_ts": "2024-01-15T11:00:00.000000+00:00",
      "policy": {
        "mode": "compat",
        "mode_reason": "default",
        "policy_version": "v1",
        "is_pointerized": false,
        "policy_source": "settings"
      }
    },
    {
      "schema_version": "1.1",
      "source": "gateway",
      "operation": "memory_store",
      "correlation_id": "corr-fedcba0987654321",
      "actor_user_id": "user3",
      "requested_space": "team:restricted",
      "final_space": null,
      "decision": {
        "action": "reject",
        "reason": "user_not_in_allowlist"
      },
      "payload_sha": "xyz789",
      "payload_len": 256,
      "evidence_summary": {
        "count": 1,
        "has_strong": false,
        "uris": ["https://jira.example.com/ISSUE-123"]
      },
      "trim": {
        "was_trimmed": false,
        "why": null,
        "original_len": null
      },
      "refs": ["https://jira.example.com/ISSUE-123"],
      "event_ts": "2024-01-15T12:00:00.000000+00:00",
      "policy_mode": "strict",
      "validation": {
        "validate_refs_effective": true,
        "validate_refs_reason": "strict_mode",
        "evidence_validation": {
          "is_valid": false,
          "error_code": "EVIDENCE_MISSING_SHA256"
        }
      }
    },
    {
      "gateway_event": {
        "schema_version": "1.1",
        "source": "gateway",
        "operation": "memory_store",
        "correlation_id": "corr-0123456789abcdef",
        "actor_user_id": "user1",
        "requested_space": "team:project",
        "final_space": "team:project",
        "decision": {
          "action": "allow",
          "reason": "policy_passed"
        },
        "payload_sha": "content_sha256",
        "payload_len": 2048,
        "evidence_summary": {
          "count": 2,
          "has_strong": true,
          "uris": [
            "memory://patch_blobs/git/1:abc123/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
            "https://example.com/doc"
          ]
        },
        "trim": {
          "was_trimmed": false,
          "why": null,
          "original_len": null
        },
        "refs": [
          "memory://patch_blobs/git/1:abc123/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
          "https://example.com/doc"
        ],
        "event_ts": "2024-01-15T14:00:00.000000+00:00",
        "policy": {
          "mode": "strict",
          "mode_reason": "explicit_header",
          "policy_version": "v2",
          "is_pointerized": false,
          "policy_source": "settings"
        },
        "validation": {
          "validate_refs_effective": true,
          "validate_refs_reason": "strict_mode",
          "evidence_validation": {
            "is_valid": true,
            "error_code": null
          }
        }
      },
      "patches": [
        {
          "artifact_uri": "memory://patch_blobs/git/1:abc123/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
          "sha256": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
          "source_type": "git",
          "source_id": "abc123"
        }
      ],
      "external": [
        {
          "uri": "https://example.com/doc"
        }
      ],
      "evidence_summary": {
        "count": 2,
        "has_strong": true,
        "uris": [
          "memory://patch_blobs/git/1:abc123/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
          "https://example.com/doc"
        ]
      }
    }
  ]
}
