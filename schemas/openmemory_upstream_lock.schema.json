{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/openmemory_upstream_lock.schema.json",
  "title": "OpenMemory Upstream Lock Schema",
  "description": "Engram 项目对 OpenMemory 上游依赖的锁定与追踪文件的 JSON Schema",
  "type": "object",
  "required": [
    "upstream_url",
    "upstream_ref",
    "upstream_ref_type",
    "integration_method",
    "patched_files",
    "components"
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema 引用"
    },
    "$id": {
      "type": "string",
      "description": "文件标识"
    },
    "description": {
      "type": "string",
      "description": "文件用途说明"
    },
    "upstream_url": {
      "type": "string",
      "format": "uri",
      "description": "上游仓库 URL",
      "pattern": "^https://github\\.com/.+/.+"
    },
    "upstream_ref": {
      "type": "string",
      "description": "上游版本引用（tag 或 commit SHA）",
      "minLength": 1
    },
    "upstream_ref_type": {
      "type": "string",
      "enum": ["tag", "commit", "branch"],
      "description": "引用类型"
    },
    "upstream_commit_sha": {
      "type": ["string", "null"],
      "pattern": "^[a-f0-9]{40}$",
      "description": "上游 commit SHA（40位十六进制）"
    },
    "upstream_commit_sha_note": {
      "type": "string"
    },
    "upstream_commit_date": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "上游 commit 日期（ISO 8601）"
    },
    "upstream_commit_date_note": {
      "type": "string"
    },
    "upstream_note": {
      "type": "string",
      "description": "版本相关备注"
    },
    "integration_method": {
      "type": "string",
      "enum": ["vendored", "submodule", "package"],
      "description": "集成方式"
    },
    "integration_method_note": {
      "type": "string"
    },
    "previous_submodule_commit": {
      "type": ["string", "null"],
      "pattern": "^[a-f0-9]{40}$"
    },
    "previous_submodule_commit_note": {
      "type": "string"
    },
    "archive_info": {
      "type": "object",
      "description": "归档下载信息",
      "properties": {
        "sha256": {
          "type": ["string", "null"],
          "pattern": "^[a-f0-9]{64}$"
        },
        "sha256_note": {
          "type": "string"
        },
        "ref": {
          "type": ["string", "null"]
        },
        "ref_type": {
          "type": ["string", "null"]
        }
      }
    },
    "local_patchset_id": {
      "type": "string",
      "description": "本地补丁集标识",
      "pattern": "^engram-patches-\\d{8}-\\d{3}$"
    },
    "local_patchset_version": {
      "type": "string",
      "description": "补丁集版本号",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "patched_files": {
      "type": "array",
      "description": "被补丁修改的文件列表",
      "items": {
        "type": "object",
        "required": ["path", "patch_count", "categories"],
        "properties": {
          "path": {
            "type": "string",
            "description": "文件路径（相对于 workspace root）",
            "pattern": "^libs/OpenMemory/.+"
          },
          "patch_count": {
            "type": "integer",
            "minimum": 0
          },
          "categories": {
            "type": "object",
            "properties": {
              "A_must_keep": {
                "type": "integer",
                "minimum": 0
              },
              "B_upstreamable": {
                "type": "integer",
                "minimum": 0
              },
              "C_removable": {
                "type": "integer",
                "minimum": 0
              }
            }
          },
          "summary": {
            "type": "string"
          }
        }
      }
    },
    "components": {
      "type": "object",
      "description": "组件目录路径映射",
      "additionalProperties": {
        "type": "string"
      }
    },
    "patches_manifest": {
      "type": "object",
      "properties": {
        "file": {
          "type": "string"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "last_sync_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "最后同步时间"
    },
    "last_sync_by": {
      "type": "string"
    },
    "sync_method": {
      "type": "string"
    },
    "sync_note": {
      "type": "string"
    },
    "engram_required_envs": {
      "type": "array",
      "description": "Engram 要求的环境变量",
      "items": {
        "type": "object",
        "required": ["name", "required"],
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^OM_[A-Z_]+$"
          },
          "required": {
            "type": "boolean"
          },
          "constraint": {
            "type": "string"
          },
          "default": {
            "type": ["string", "null", "boolean"]
          },
          "description": {
            "type": "string"
          }
        }
      }
    },
    "upgrade_checklist": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "rollback_procedure": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "format_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "created_by": {
          "type": "string"
        },
        "tool_compatible": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "artifacts": {
      "type": "object",
      "properties": {
        "description": {
          "type": "string"
        },
        "upstream_source": {
          "type": "object",
          "properties": {
            "path": {
              "type": "string"
            },
            "sha256": {
              "type": ["string", "null"]
            },
            "sha256_note": {
              "type": "string"
            }
          }
        }
      }
    },
    "checksums": {
      "type": "object",
      "description": "补丁文件的 SHA256 校验和",
      "properties": {
        "description": {
          "type": "string"
        },
        "patched_files": {
          "type": "object",
          "description": "每个被补丁文件的校验和信息",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "after": {
                "type": ["string", "null"],
                "pattern": "^[a-f0-9]{64}$",
                "description": "应用补丁后的文件 SHA256"
              },
              "base": {
                "type": ["string", "null"],
                "pattern": "^[a-f0-9]{64}$",
                "description": "上游原始文件 SHA256（由 fetch/sync 命令从 upstream archive 计算）"
              },
              "base_note": {
                "type": "string"
              },
              "base_ref": {
                "type": ["string", "null"],
                "description": "base 来源的版本引用（如 v1.3.0）"
              },
              "base_ref_type": {
                "type": ["string", "null"],
                "enum": ["tag", "commit", "branch", null],
                "description": "base 来源的引用类型"
              },
              "base_commit_sha": {
                "type": ["string", "null"],
                "pattern": "^[a-f0-9]{40}$",
                "description": "base 来源的 commit SHA"
              }
            }
          }
        }
      }
    },
    "upgrade_policy": {
      "type": "object",
      "description": "升级策略与规则",
      "properties": {
        "description": {
          "type": "string"
        },
        "check_frequency": {
          "type": "string"
        },
        "check_frequency_note": {
          "type": "string"
        },
        "merge_frequency": {
          "type": "string"
        },
        "merge_frequency_note": {
          "type": "string"
        },
        "security_exception": {
          "type": "object"
        },
        "freeze_rules": {
          "type": "object",
          "description": "升级冻结规则配置",
          "properties": {
            "description": {
              "type": "string",
              "description": "冻结规则总体说明"
            },
            "rules": {
              "type": "array",
              "description": "结构化冻结规则列表",
              "items": {
                "type": "object",
                "required": ["id", "enabled", "scope", "condition"],
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "规则唯一标识符",
                    "pattern": "^[a-z][a-z0-9_]*$"
                  },
                  "enabled": {
                    "type": "boolean",
                    "description": "规则是否启用"
                  },
                  "scope": {
                    "type": "array",
                    "description": "规则适用的操作范围",
                    "items": {
                      "type": "string",
                      "enum": ["upstream_ref_update", "sync", "patch_apply", "rollback"]
                    },
                    "minItems": 1
                  },
                  "condition": {
                    "type": "object",
                    "description": "触发冻结的条件配置",
                    "required": ["type"],
                    "properties": {
                      "type": {
                        "type": "string",
                        "enum": ["flag", "time_window", "conflict_check", "custom"],
                        "description": "条件类型"
                      },
                      "flag_name": {
                        "type": "string",
                        "description": "标志名称（type=flag 时使用）"
                      },
                      "expected_value": {
                        "description": "期望的标志值（type=flag 时使用）"
                      },
                      "relative_to": {
                        "type": "string",
                        "description": "时间窗口参考点（type=time_window 时使用）"
                      },
                      "days_before": {
                        "type": "integer",
                        "minimum": 1,
                        "description": "提前天数（type=time_window 时使用）"
                      },
                      "category": {
                        "type": "string",
                        "description": "补丁分类（type=conflict_check 时使用）"
                      },
                      "conflict_severity": {
                        "type": "string",
                        "enum": ["minor", "major", "unresolvable"],
                        "description": "冲突严重程度（type=conflict_check 时使用）"
                      }
                    },
                    "additionalProperties": true
                  },
                  "reason_template": {
                    "type": "string",
                    "description": "冻结原因模板，支持变量替换"
                  },
                  "override": {
                    "type": "object",
                    "description": "覆盖此规则的要求",
                    "properties": {
                      "min_reason_len": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "覆盖时需要的最小理由长度"
                      },
                      "authority_label": {
                        "type": "string",
                        "description": "有权覆盖此规则的角色标签"
                      }
                    },
                    "additionalProperties": true
                  }
                },
                "additionalProperties": true
              }
            },
            "rules_note": {
              "type": "string",
              "description": "rules 字段说明"
            },
            "conditions_deprecated": {
              "type": "array",
              "description": "已废弃的条件列表（保留用于向后兼容）",
              "items": {
                "type": "string"
              }
            },
            "override_authority": {
              "type": "string",
              "description": "默认覆盖权限角色"
            },
            "override_authority_note": {
              "type": "string",
              "description": "覆盖权限说明"
            }
          },
          "additionalProperties": true
        },
        "conflict_resolution": {
          "type": "object"
        }
      }
    },
    "freeze_status": {
      "type": "object",
      "description": "冻结状态",
      "properties": {
        "is_frozen": {
          "type": "boolean"
        },
        "is_frozen_note": {
          "type": "string"
        },
        "freeze_reason": {
          "type": ["string", "null"]
        },
        "freeze_reason_note": {
          "type": "string"
        },
        "freeze_started_at": {
          "type": ["string", "null"]
        },
        "freeze_expires_at": {
          "type": ["string", "null"]
        },
        "freeze_expires_at_note": {
          "type": "string"
        },
        "last_override_by": {
          "type": ["string", "null"]
        },
        "last_override_at": {
          "type": ["string", "null"]
        },
        "last_override_reason": {
          "type": ["string", "null"]
        }
      }
    }
  },
  "additionalProperties": true
}
