{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/unified_stack_verify_results_v2.schema.json",
  "title": "Unified Stack Verify Results V2 Schema",
  "description": "Engram Unified Stack 验证结果 (verify_unified_stack.sh --json-out) 的 JSON Schema (V2)",

  "type": "object",
  "required": ["verify_mode", "overall_status", "total_failed", "total_duration_ms", "gateway_url", "openmemory_url", "timestamp", "steps"],
  "additionalProperties": true,

  "definitions": {
    "step_status": {
      "type": "string",
      "description": "步骤状态",
      "enum": ["ok", "fail", "skipped"]
    },

    "reason_code": {
      "type": "string",
      "description": "跳过或失败原因代码",
      "enum": [
        "no_postgres_dsn",
        "no_docker",
        "docker_not_connectable",
        "no_db_tools",
        "no_psycopg",
        "cannot_resolve_container",
        "cannot_stop_container",
        "container_still_running",
        "cannot_restart_container",
        "recovery_timeout",
        "request_failed",
        "response_check_failed",
        "query_failed"
      ]
    },

    "capabilities": {
      "type": "object",
      "description": "环境 capability 探测结果",
      "properties": {
        "docker": {
          "type": "boolean",
          "description": "docker 命令可用"
        },
        "docker_available": {
          "type": "boolean",
          "description": "docker 命令可用（别名）"
        },
        "docker_connectable": {
          "type": "boolean",
          "description": "docker daemon 可连接"
        },
        "compose": {
          "type": "boolean",
          "description": "docker compose 可用"
        },
        "psql": {
          "type": "boolean",
          "description": "psql 命令可用"
        },
        "psql_available": {
          "type": "boolean",
          "description": "psql 命令可用（别名）"
        },
        "python": {
          "type": "boolean",
          "description": "python/python3 可用"
        },
        "python_psycopg": {
          "type": "boolean",
          "description": "python psycopg/psycopg2 可用"
        },
        "postgres_dsn": {
          "type": "boolean",
          "description": "POSTGRES_DSN 环境变量已设置"
        },
        "container_resolvable": {
          "type": "boolean",
          "description": "OpenMemory 容器可解析"
        },
        "container_stoppable": {
          "type": "boolean",
          "description": "OpenMemory 容器可停止"
        },
        "compose_project_name": {
          "type": "string",
          "description": "docker-compose 项目名称"
        },
        "compose_file": {
          "type": "string",
          "description": "docker-compose 文件路径"
        },
        "profile": {
          "type": "string",
          "description": "当前使用的 profile (http_only/standard/full)"
        }
      },
      "additionalProperties": true
    },

    "step": {
      "type": "object",
      "description": "验证步骤结果",
      "required": ["name", "status", "duration_ms"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "description": "步骤名称",
          "enum": [
            "health_checks",
            "db_invariants",
            "memory_store",
            "memory_query",
            "jsonrpc",
            "degradation",
            "audit_gc_smoke",
            "tool_check"
          ]
        },
        "status": {
          "$ref": "#/definitions/step_status"
        },
        "duration_ms": {
          "type": "integer",
          "description": "步骤耗时（毫秒）",
          "minimum": 0
        },
        "required": {
          "type": "boolean",
          "description": "该步骤是否按当前 profile 必须执行"
        },
        "reason": {
          "$ref": "#/definitions/reason_code",
          "description": "跳过或失败原因代码"
        },
        "error": {
          "type": "string",
          "description": "错误描述"
        },
        "gateway_ok": {
          "type": "boolean",
          "description": "Gateway 健康状态（health_checks 步骤）"
        },
        "openmemory_ok": {
          "type": "boolean",
          "description": "OpenMemory 健康状态（health_checks 步骤）"
        },
        "action": {
          "type": "string",
          "description": "memory_store 操作结果"
        },
        "has_outbox_id": {
          "type": "boolean",
          "description": "是否降级到 outbox"
        },
        "memory_id": {
          "type": "string",
          "description": "memory_store 返回的 memory_id"
        },
        "results_count": {
          "type": "integer",
          "description": "memory_query 返回的结果数",
          "minimum": 0
        },
        "tools_count": {
          "type": "integer",
          "description": "jsonrpc tools/list 返回的工具数",
          "minimum": 0
        },
        "db_tool": {
          "type": "string",
          "description": "使用的数据库工具（psql/python）"
        },
        "audit_total": {
          "type": "integer",
          "description": "审计记录总数",
          "minimum": 0
        },
        "audit_allow": {
          "type": "integer",
          "description": "allow 操作数",
          "minimum": 0
        },
        "audit_redirect": {
          "type": "integer",
          "description": "redirect 操作数",
          "minimum": 0
        },
        "audit_reject": {
          "type": "integer",
          "description": "reject 操作数",
          "minimum": 0
        },
        "outbox_total": {
          "type": "integer",
          "description": "outbox 记录总数",
          "minimum": 0
        },
        "outbox_pending": {
          "type": "integer",
          "description": "outbox pending 记录数",
          "minimum": 0
        },
        "outbox_sent": {
          "type": "integer",
          "description": "outbox sent 记录数",
          "minimum": 0
        },
        "outbox_dead": {
          "type": "integer",
          "description": "outbox dead 记录数",
          "minimum": 0
        }
      }
    }
  },

  "properties": {
    "verify_mode": {
      "type": "string",
      "description": "验证模式",
      "enum": ["default", "stepwise", "auto"]
    },

    "overall_status": {
      "type": "string",
      "description": "整体验证状态",
      "enum": ["pass", "fail"]
    },

    "total_failed": {
      "type": "integer",
      "description": "失败的测试步骤数",
      "minimum": 0
    },

    "total_duration_ms": {
      "type": "integer",
      "description": "总耗时（毫秒）",
      "minimum": 0
    },

    "gateway_url": {
      "type": "string",
      "description": "Gateway 服务地址",
      "format": "uri"
    },

    "openmemory_url": {
      "type": "string",
      "description": "OpenMemory 服务地址",
      "format": "uri"
    },

    "timestamp": {
      "type": "string",
      "description": "验证时间戳（ISO8601）",
      "format": "date-time"
    },

    "capabilities": {
      "$ref": "#/definitions/capabilities",
      "description": "环境 capability 探测结果"
    },

    "steps": {
      "type": "array",
      "description": "验证步骤结果列表",
      "items": {
        "$ref": "#/definitions/step"
      },
      "minItems": 1
    }
  },

  "allOf": [
    {
      "description": "overall_status=pass 时 total_failed 必须为 0",
      "if": {
        "properties": {
          "overall_status": { "const": "pass" }
        }
      },
      "then": {
        "properties": {
          "total_failed": { "const": 0 }
        }
      }
    }
  ],

  "examples": [
    {
      "verify_mode": "default",
      "overall_status": "pass",
      "total_failed": 0,
      "total_duration_ms": 12345,
      "gateway_url": "http://localhost:8787",
      "openmemory_url": "http://localhost:8080",
      "timestamp": "2026-01-29T10:00:00+08:00",
      "capabilities": {
        "docker": true,
        "docker_connectable": true,
        "compose": true,
        "psql": true,
        "python": true,
        "python_psycopg": true,
        "postgres_dsn": true,
        "container_resolvable": true,
        "container_stoppable": true
      },
      "steps": [
        {
          "name": "health_checks",
          "status": "ok",
          "duration_ms": 500,
          "required": true,
          "gateway_ok": true,
          "openmemory_ok": true
        },
        {
          "name": "memory_store",
          "status": "ok",
          "duration_ms": 200,
          "required": true,
          "action": "allow",
          "has_outbox_id": false,
          "memory_id": "abc123"
        },
        {
          "name": "memory_query",
          "status": "ok",
          "duration_ms": 150,
          "required": true,
          "results_count": 5
        },
        {
          "name": "jsonrpc",
          "status": "ok",
          "duration_ms": 300,
          "required": true,
          "tools_count": 4
        }
      ]
    },
    {
      "verify_mode": "default",
      "overall_status": "pass",
      "total_failed": 0,
      "total_duration_ms": 25000,
      "gateway_url": "http://localhost:8787",
      "openmemory_url": "http://localhost:8080",
      "timestamp": "2026-01-29T10:00:00+08:00",
      "capabilities": {
        "docker": true,
        "docker_connectable": true,
        "compose": true,
        "psql": true,
        "python": true,
        "python_psycopg": true,
        "postgres_dsn": true,
        "container_resolvable": true,
        "container_stoppable": true,
        "compose_project_name": "engram",
        "compose_file": "docker-compose.yml",
        "profile": "full"
      },
      "steps": [
        {
          "name": "health_checks",
          "status": "ok",
          "duration_ms": 500,
          "required": true,
          "gateway_ok": true,
          "openmemory_ok": true
        },
        {
          "name": "memory_store",
          "status": "ok",
          "duration_ms": 200,
          "required": true,
          "action": "allow",
          "has_outbox_id": false,
          "memory_id": "abc123"
        },
        {
          "name": "memory_query",
          "status": "ok",
          "duration_ms": 150,
          "required": true,
          "results_count": 5
        },
        {
          "name": "jsonrpc",
          "status": "ok",
          "duration_ms": 300,
          "required": true,
          "tools_count": 4
        },
        {
          "name": "degradation",
          "status": "ok",
          "duration_ms": 15000,
          "required": true,
          "has_outbox_id": true
        }
      ]
    },
    {
      "verify_mode": "stepwise",
      "overall_status": "pass",
      "total_failed": 0,
      "total_duration_ms": 5000,
      "gateway_url": "http://localhost:8787",
      "openmemory_url": "http://localhost:8080",
      "timestamp": "2026-01-29T10:00:00+08:00",
      "capabilities": {
        "docker": false,
        "docker_connectable": false,
        "compose": false,
        "psql": false,
        "python": true,
        "python_psycopg": false,
        "postgres_dsn": false,
        "container_resolvable": false,
        "container_stoppable": false
      },
      "steps": [
        {
          "name": "health_checks",
          "status": "ok",
          "duration_ms": 500,
          "gateway_ok": true,
          "openmemory_ok": true
        },
        {
          "name": "db_invariants",
          "status": "skipped",
          "duration_ms": 0,
          "reason": "no_postgres_dsn"
        },
        {
          "name": "memory_store",
          "status": "ok",
          "duration_ms": 200,
          "action": "allow",
          "has_outbox_id": false,
          "memory_id": "abc123"
        },
        {
          "name": "memory_query",
          "status": "ok",
          "duration_ms": 150,
          "results_count": 5
        },
        {
          "name": "jsonrpc",
          "status": "ok",
          "duration_ms": 300,
          "tools_count": 4
        }
      ]
    },
    {
      "verify_mode": "default",
      "overall_status": "fail",
      "total_failed": 2,
      "total_duration_ms": 1000,
      "gateway_url": "http://localhost:8787",
      "openmemory_url": "http://localhost:8080",
      "timestamp": "2026-01-29T10:00:00+08:00",
      "capabilities": {
        "docker": false,
        "docker_connectable": false,
        "compose": false,
        "psql": false,
        "python": true,
        "python_psycopg": false,
        "postgres_dsn": false,
        "container_resolvable": false,
        "container_stoppable": false
      },
      "steps": [
        {
          "name": "health_checks",
          "status": "ok",
          "duration_ms": 500,
          "gateway_ok": true,
          "openmemory_ok": true
        },
        {
          "name": "db_invariants",
          "status": "fail",
          "duration_ms": 0,
          "reason": "no_postgres_dsn"
        },
        {
          "name": "degradation",
          "status": "fail",
          "duration_ms": 0,
          "reason": "no_docker"
        }
      ]
    }
  ]
}
