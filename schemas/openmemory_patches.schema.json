{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/openmemory_patches.schema.json",
  "title": "OpenMemory Patches Schema",
  "description": "Engram 项目对 OpenMemory 补丁清单文件的 JSON Schema",
  "type": "object",
  "required": [
    "baseline",
    "analysis_date",
    "patches",
    "summary"
  ],
  "properties": {
    "baseline": {
      "type": "object",
      "description": "基线版本信息",
      "required": ["project"],
      "properties": {
        "project": {
          "type": "string",
          "description": "项目名称"
        },
        "reference": {
          "type": "string",
          "format": "uri",
          "description": "上游仓库引用"
        },
        "estimated_version": {
          "type": "string",
          "description": "估计的上游版本"
        },
        "note": {
          "type": "string"
        }
      }
    },
    "analysis_date": {
      "type": "string",
      "format": "date",
      "description": "分析日期（YYYY-MM-DD）"
    },
    "patch_generation": {
      "type": "object",
      "description": "补丁生成配置",
      "properties": {
        "method": {
          "type": "string",
          "description": "生成方法"
        },
        "description": {
          "type": "string"
        },
        "commands": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          }
        },
        "base_snapshot_note": {
          "type": "string"
        }
      }
    },
    "patches": {
      "type": "array",
      "description": "补丁文件列表",
      "items": {
        "type": "object",
        "required": ["file", "changes"],
        "properties": {
          "file": {
            "type": "string",
            "description": "被修改的文件路径",
            "pattern": "^libs/OpenMemory/.+"
          },
          "changes": {
            "type": "array",
            "description": "该文件的修改列表",
            "items": {
              "type": "object",
              "required": ["id", "location", "description", "category"],
              "properties": {
                "id": {
                  "type": "string",
                  "description": "补丁标识符",
                  "pattern": "^[a-z]+-\\d{3}$"
                },
                "location": {
                  "type": "string",
                  "description": "修改位置（行号或函数名）"
                },
                "description": {
                  "type": "string",
                  "description": "修改描述"
                },
                "category": {
                  "type": "string",
                  "enum": ["A", "B", "C"],
                  "description": "补丁分类：A=必须保留，B=可上游化，C=可移除"
                },
                "reason": {
                  "type": "string",
                  "description": "修改原因"
                },
                "impact": {
                  "type": "string",
                  "description": "影响程度"
                },
                "upstream_potential": {
                  "type": "boolean",
                  "description": "是否有上游化潜力"
                },
                "refactor_suggestion": {
                  "type": "string",
                  "description": "重构建议"
                },
                "patch_file": {
                  "type": "string",
                  "description": "补丁文件路径",
                  "pattern": "^patches/openmemory/[ABC]/.+\\.patch$"
                },
                "patch_sha256": {
                  "type": ["string", "null"],
                  "pattern": "^[a-f0-9]{64}$"
                },
                "applies_to_ref": {
                  "type": "string",
                  "description": "适用的上游版本引用"
                }
              }
            }
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "description": "补丁汇总统计",
      "required": ["total_patches", "category_A_must_keep", "category_B_upstreamable", "category_C_removable"],
      "properties": {
        "total_patches": {
          "type": "integer",
          "minimum": 0,
          "description": "总补丁数"
        },
        "category_A_must_keep": {
          "type": "integer",
          "minimum": 0,
          "description": "Category A（必须保留）补丁数"
        },
        "category_B_upstreamable": {
          "type": "integer",
          "minimum": 0,
          "description": "Category B（可上游化）补丁数"
        },
        "category_C_removable": {
          "type": "integer",
          "minimum": 0,
          "description": "Category C（可移除）补丁数"
        },
        "category_A_details": {
          "type": "string"
        },
        "category_B_details": {
          "type": "string"
        },
        "category_C_details": {
          "type": "string"
        },
        "bundle_sha256": {
          "type": ["string", "null"],
          "pattern": "^[a-f0-9]{64}$"
        },
        "bundle_sha256_note": {
          "type": "string"
        }
      }
    },
    "patch_files_manifest": {
      "type": "object",
      "description": "补丁文件清单",
      "properties": {
        "description": {
          "type": "string"
        },
        "base_dir": {
          "type": "string"
        },
        "categories": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "path": {
                "type": "string"
              },
              "count": {
                "type": "integer",
                "minimum": 0
              },
              "files": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          }
        }
      }
    },
    "recommendations": {
      "type": "array",
      "description": "改进建议",
      "items": {
        "type": "object",
        "required": ["priority", "action", "description"],
        "properties": {
          "priority": {
            "type": "integer",
            "minimum": 1
          },
          "action": {
            "type": "string"
          },
          "description": {
            "type": "string"
          }
        }
      }
    }
  },
  "additionalProperties": true
}
