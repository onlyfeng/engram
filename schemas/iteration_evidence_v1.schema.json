{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/engram/schemas/iteration_evidence_v1.schema.json",
  "title": "Iteration Evidence V1 Schema",
  "description": "迭代验收证据 Schema (V1)。用于记录迭代回归验证的结构化证据，作为版本化证据文件的格式 SSOT。注意：此 schema 明确禁止包含敏感信息（如密码、DSN 原文、API 密钥等）。",

  "type": "object",
  "required": ["iteration_number", "recorded_at", "commit_sha", "runner", "commands"],
  "additionalProperties": false,

  "definitions": {
    "command_result": {
      "type": "string",
      "description": "命令执行结果状态",
      "enum": ["PASS", "FAIL", "SKIP", "ERROR"]
    },

    "command_entry": {
      "type": "object",
      "description": "单个门禁命令的执行记录",
      "required": ["name", "command", "result"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "门禁命令的人类可读名称（如 'lint', 'typecheck', 'test'）",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "command": {
          "type": "string",
          "description": "实际执行的命令（如 'make ci'）。禁止包含密码、API 密钥、DSN 等敏感信息。",
          "minLength": 1,
          "maxLength": 512
        },
        "result": {
          "$ref": "#/definitions/command_result"
        },
        "summary": {
          "type": "string",
          "description": "执行结果摘要（如 '142 passed, 0 failed'）。禁止包含敏感信息。",
          "maxLength": 512
        },
        "duration_seconds": {
          "type": "number",
          "description": "命令执行耗时（秒）",
          "minimum": 0
        },
        "exit_code": {
          "type": "integer",
          "description": "命令退出码",
          "minimum": 0,
          "maximum": 255
        }
      }
    },

    "runner_info": {
      "type": "object",
      "description": "执行环境信息",
      "required": ["os", "python", "arch"],
      "additionalProperties": false,
      "properties": {
        "os": {
          "type": "string",
          "description": "操作系统及版本（如 'ubuntu-22.04', 'darwin-24.6.0'）",
          "minLength": 1,
          "maxLength": 64
        },
        "python": {
          "type": "string",
          "description": "Python 版本（如 '3.11.9', '3.12.0'）",
          "pattern": "^\\d+\\.\\d+(\\.\\d+)?$"
        },
        "arch": {
          "type": "string",
          "description": "CPU 架构（如 'x86_64', 'arm64'）",
          "enum": ["x86_64", "arm64", "aarch64", "i686", "i386"]
        },
        "hostname": {
          "type": "string",
          "description": "主机名（可选，禁止包含敏感域名或内部 IP）。仅用于区分运行环境，不应暴露内部基础设施信息。",
          "maxLength": 64
        },
        "runner_label": {
          "type": "string",
          "description": "CI runner 标签（如 'ubuntu-latest', 'self-hosted'）",
          "maxLength": 64
        }
      }
    },

    "links": {
      "type": "object",
      "description": "相关链接集合",
      "additionalProperties": false,
      "properties": {
        "ci_run_url": {
          "type": "string",
          "description": "CI 运行页面 URL（如 GitHub Actions run URL）",
          "format": "uri",
          "maxLength": 512
        },
        "pr_url": {
          "type": "string",
          "description": "关联的 Pull Request URL",
          "format": "uri",
          "maxLength": 512
        },
        "artifact_url": {
          "type": "string",
          "description": "CI Artifacts 下载 URL（注意：有时效性，通常 90 天）",
          "format": "uri",
          "maxLength": 512
        },
        "regression_doc_url": {
          "type": "string",
          "description": "关联的回归文档 URL 或相对路径",
          "maxLength": 512
        }
      }
    }
  },

  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema 引用（可选）",
      "format": "uri-reference"
    },

    "iteration_number": {
      "type": "integer",
      "description": "迭代编号（正整数）",
      "minimum": 1
    },

    "recorded_at": {
      "type": "string",
      "description": "证据记录时间（ISO 8601 格式，UTC 时区）",
      "format": "date-time"
    },

    "commit_sha": {
      "type": "string",
      "description": "验证时的 Git commit SHA（完整 40 字符或短 SHA）",
      "pattern": "^[a-f0-9]{7,40}$"
    },

    "runner": {
      "$ref": "#/definitions/runner_info"
    },

    "commands": {
      "type": "array",
      "description": "执行的门禁命令列表",
      "items": {
        "$ref": "#/definitions/command_entry"
      },
      "minItems": 1
    },

    "links": {
      "$ref": "#/definitions/links"
    },

    "notes": {
      "type": "string",
      "description": "补充说明（可选）。禁止包含敏感信息。",
      "maxLength": 2048
    },

    "overall_result": {
      "type": "string",
      "description": "整体验收结果",
      "enum": ["PASS", "PARTIAL", "FAIL"]
    },

    "sensitive_data_declaration": {
      "type": "boolean",
      "description": "声明此文件不包含敏感信息。记录者应确保所有字段值均不包含密码、API 密钥、数据库连接字符串、内部 IP 地址等敏感信息。",
      "const": true
    }
  },

  "examples": [
    {
      "$schema": "./iteration_evidence_v1.schema.json",
      "iteration_number": 13,
      "recorded_at": "2026-02-02T14:30:22Z",
      "commit_sha": "abc1234def5678901234567890abcdef12345678",
      "runner": {
        "os": "ubuntu-22.04",
        "python": "3.11.9",
        "arch": "x86_64",
        "runner_label": "ubuntu-latest"
      },
      "commands": [
        {
          "name": "lint",
          "command": "make lint",
          "result": "PASS",
          "summary": "ruff check passed",
          "duration_seconds": 5.2,
          "exit_code": 0
        },
        {
          "name": "typecheck",
          "command": "make typecheck",
          "result": "PASS",
          "summary": "mypy passed with 0 errors",
          "duration_seconds": 12.8,
          "exit_code": 0
        },
        {
          "name": "test",
          "command": "make test",
          "result": "PASS",
          "summary": "142 passed, 0 failed",
          "duration_seconds": 45.3,
          "exit_code": 0
        }
      ],
      "links": {
        "ci_run_url": "https://github.com/example/engram/actions/runs/1234567890",
        "regression_doc_url": "docs/acceptance/iteration_13_regression.md"
      },
      "notes": "所有最小门禁通过，验收完成。",
      "overall_result": "PASS",
      "sensitive_data_declaration": true
    }
  ]
}
