name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  # ============================================================================
  # 代码检查和测试
  # ============================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # 防止 Python 生成 .pyc 字节码缓存文件
      # 避免缓存导致的测试隔离问题和 import 不一致
      PYTHONDONTWRITEBYTECODE: "1"

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: engram_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[full,dev]"

      - name: Run database migrations
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          ENGRAM_TESTING: "1"
        run: |
          # 执行 DDL 迁移 + 角色权限应用
          # 使用 tee 同时输出到终端和日志文件，便于调试
          # 2>&1: 合并 stderr 到 stdout，确保错误信息也被记录
          python -m engram.logbook.cli.db_migrate \
            --dsn "$POSTGRES_DSN" \
            --apply-roles \
            --apply-openmemory-grants \
            2>&1 | tee migration-output-${{ matrix.python-version }}.log
          # PIPESTATUS[0] 获取管道中第一个命令（Python 脚本）的退出码
          # 这是必要的，因为 tee 始终返回 0，会掩盖 Python 脚本的失败
          exit ${PIPESTATUS[0]}

      - name: Verify database migrations (strict mode)
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          ENGRAM_TESTING: "1"
        run: |
          # 严格模式验证：仅 FAIL 会导致非零退出码，阻断 CI（默认 fail_only 策略）
          # --verify-strict: 启用门禁检查，FAIL 项存在时返回非零退出码
          # 注意：WARN 不会导致失败，如需 WARN 也触发，需设置 gate_policy=fail_and_warn
          # 日志留存用于失败时的问题诊断
          python -m engram.logbook.cli.db_migrate \
            --dsn "$POSTGRES_DSN" \
            --verify \
            --verify-strict \
            2>&1 | tee verify-output-${{ matrix.python-version }}.log
          # 同样使用 PIPESTATUS[0] 传递正确的退出码
          exit ${PIPESTATUS[0]}

      - name: Run unit and integration tests
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_ADMIN_DSN: postgresql://postgres:postgres@localhost:5432/postgres
          PROJECT_KEY: test
        run: |
          pytest tests/gateway/ -v --junitxml=test-results-${{ matrix.python-version }}.xml

      - name: Run acceptance tests
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_ADMIN_DSN: postgresql://postgres:postgres@localhost:5432/postgres
          PROJECT_KEY: test
        run: |
          pytest tests/acceptance/ -v --junitxml=acceptance-results-${{ matrix.python-version }}.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results-${{ matrix.python-version }}.xml
            acceptance-results-${{ matrix.python-version }}.xml
          retention-days: 14

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ matrix.python-version }}
          path: |
            migration-output-${{ matrix.python-version }}.log
            verify-output-${{ matrix.python-version }}.log
          retention-days: 14

  # ============================================================================
  # 代码质量检查
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[full,dev]"

      - name: Run ruff check (lint)
        run: ruff check src/ tests/

      - name: Run ruff format check
        run: ruff format --check src/ tests/

      # ============================================================
      # mypy 门禁检查 - 动态解析 gate
      # 流程: baseline_count -> resolve_gate -> check_mypy_gate
      # 文档: docs/architecture/adr_mypy_baseline_and_gating.md
      # ============================================================

      - name: Count mypy baseline errors
        id: baseline-count
        run: |
          # 优先使用 mypy_metrics.py 获取准确的 total_errors（排除 note 行）
          # Fallback: 使用 wc -l（包含 note 行，数值略高）
          mkdir -p artifacts

          if python -m scripts.ci.mypy_metrics --output artifacts/mypy_metrics.json 2>/dev/null; then
            # 从 mypy_metrics 获取 total_errors（主口径）
            COUNT=$(python -c "import json; print(json.load(open('artifacts/mypy_metrics.json'))['summary']['total_errors'])" 2>/dev/null || echo "0")
            echo "[INFO] 使用 mypy_metrics 口径: total_errors=${COUNT}"
          else
            # Fallback: 使用 wc -l（备选口径，包含 note 行）
            BASELINE_FILE="scripts/ci/mypy_baseline.txt"
            if [ -f "$BASELINE_FILE" ]; then
              COUNT=$(wc -l < "$BASELINE_FILE" | tr -d ' ')
            else
              COUNT=0
            fi
            echo "[WARN] mypy_metrics 不可用，使用 wc -l fallback: count=${COUNT}"
          fi
          echo "count=${COUNT}" >> $GITHUB_OUTPUT
          echo "[INFO] baseline_count=${COUNT}"

      - name: Resolve mypy gate
        id: resolve-mypy-gate
        run: |
          # 根据迁移阶段、分支、阈值解析最终的 gate 级别
          # 回滚开关: ENGRAM_MYPY_GATE_OVERRIDE (优先级最高)
          # 文档: docs/dev/ci_gate_runbook.md#31-mypy-门禁回滚
          GATE=$(python -m scripts.ci.resolve_mypy_gate \
            --phase "${{ vars.ENGRAM_MYPY_MIGRATION_PHASE || '0' }}" \
            --override "${{ vars.ENGRAM_MYPY_GATE_OVERRIDE || '' }}" \
            --threshold "${{ vars.ENGRAM_MYPY_STRICT_THRESHOLD || '0' }}" \
            --baseline-count "${{ steps.baseline-count.outputs.count }}" \
            --branch "${{ github.head_ref || '' }}" \
            --ref "${{ github.ref }}" \
            --explain)
          echo "gate=${GATE}" >> $GITHUB_OUTPUT
          echo "[INFO] Resolved gate=${GATE}"

      - name: Run mypy (baseline mode)
        run: |
          # 使用解析后的 gate 执行 mypy 检查
          # gate 可能值: baseline / strict / warn / off
          python -m scripts.ci.check_mypy_gate \
            --gate "${{ steps.resolve-mypy-gate.outputs.gate }}" \
            --baseline-file scripts/ci/mypy_baseline.txt \
            --mypy-path src/engram/ \
            --verbose

      - name: Run mypy (strict-island mode)
        run: |
          # strict-island 模式: 核心模块必须零错误
          # 配置: pyproject.toml [tool.engram.mypy].strict_island_paths
          python -m scripts.ci.check_mypy_gate --gate strict-island --verbose

  # ============================================================================
  # .iteration/ 目录禁止提交检查
  # ============================================================================
  no-iteration-tracked:
    name: No .iteration/ Tracked Files
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check no .iteration files tracked
        run: |
          echo "Checking that .iteration/ is not tracked in git..."
          tracked=$(git ls-files .iteration 2>/dev/null || true)
          if [ -n "$tracked" ]; then
            echo "❌ ERROR: .iteration/ files are tracked in git!"
            echo "Tracked files:"
            echo "$tracked"
            echo ""
            echo "Please remove these files from git:"
            echo "  git rm -r --cached .iteration/"
            exit 1
          fi
          echo "✅ No .iteration/ files tracked in git"

  # ============================================================================
  # 环境变量一致性检查
  # ============================================================================
  env-var-consistency:
    name: Environment Variable Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check environment variable consistency
        run: |
          python -m scripts.ci.check_env_var_consistency --verbose
          echo "Environment variable consistency check passed"

  # ============================================================================
  # Schema 校验
  # ============================================================================
  schema-validate:
    name: Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          # 验证 jsonschema 已安装
          python -c "import jsonschema; print(f'jsonschema {jsonschema.__version__} installed')"

      - name: Run schema validation
        run: |
          python scripts/validate_schemas.py --validate-fixtures --verbose --output schema-validation-results.json

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-validation-results
          path: schema-validation-results.json
          retention-days: 14

  # ============================================================================
  # Logbook 配置一致性检查
  # ============================================================================
  logbook-consistency:
    name: Logbook Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check logbook configuration consistency
        run: |
          python scripts/verify_logbook_consistency.py --verbose
          echo "Logbook consistency check passed"

  # ============================================================================
  # 迁移 Sanity 检查（SQL 文件存在性和基本语法）
  # ============================================================================
  migration-sanity:
    name: Migration Sanity Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check SQL migration files exist
        run: |
          echo "Checking SQL migration files..."
          required_files=(
            "sql/01_logbook_schema.sql"
            "sql/02_scm_migration.sql"
            "sql/04_roles_and_grants.sql"
            "sql/05_openmemory_roles_and_grants.sql"
          )
          missing=0
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "[ERROR] Missing: $f"
              missing=$((missing + 1))
            else
              echo "[OK] Found: $f"
            fi
          done
          if [ "$missing" -gt 0 ]; then
            echo "Missing $missing required migration files"
            exit 1
          fi
          echo "All required migration files present"

      - name: Check SQL syntax (basic validation)
        run: |
          echo "Checking SQL files for common syntax issues..."
          errors=0
          for f in sql/*.sql; do
            if [ -f "$f" ]; then
              # 检查文件非空
              if [ ! -s "$f" ]; then
                echo "[WARN] Empty file: $f"
              fi
              # 检查是否包含至少一个 SQL 语句关键字
              if ! grep -qiE '(CREATE|ALTER|INSERT|SELECT|DROP|GRANT|REVOKE)' "$f"; then
                echo "[WARN] No SQL statements found in: $f"
              else
                echo "[OK] $f"
              fi
            fi
          done
          echo "SQL sanity check completed"

  # ============================================================================
  # SQL 迁移安全性检查（高危语句检测）
  # ============================================================================
  sql-safety:
    name: SQL Migration Safety Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run SQL safety check
        run: |
          echo "=== SQL 迁移安全性检查 ==="
          echo ""
          echo "检查规则："
          echo "  - Denylist: 绝对禁止的危险语句（DROP TABLE 无 IF EXISTS, TRUNCATE 等）"
          echo "  - Allowlist: 需要 -- SAFE: 或 -- BREAKING: 标记的语句"
          echo ""
          python -m pytest tests/logbook/test_sql_migrations_safety.py -v --tb=short
          echo ""
          echo "SQL 迁移安全性检查通过"

  # ============================================================================
  # Gateway DI 边界检查
  # ============================================================================
  gateway-di-boundaries:
    name: Gateway DI Boundaries Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway DI boundaries
        run: |
          python -m scripts.ci.check_gateway_di_boundaries --verbose
          echo "Gateway DI boundaries check passed"

  # ============================================================================
  # SCM Sync 一致性检查
  # ============================================================================
  scm-sync-consistency:
    name: SCM Sync Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[full,dev]"

      - name: Check SCM Sync consistency
        run: |
          python scripts/verify_scm_sync_consistency.py --verbose
          echo "SCM Sync consistency check passed"

  # ============================================================================
  # Gateway ErrorReason 使用规范检查
  # ============================================================================
  gateway-error-reason-usage:
    name: Gateway ErrorReason Usage Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway ErrorReason usage
        run: |
          python -m scripts.ci.check_gateway_error_reason_usage --verbose
          echo "Gateway ErrorReason usage check passed"

  # ============================================================================
  # Gateway Import Surface 检查（懒加载策略）
  # ============================================================================
  gateway-import-surface:
    name: Gateway Import Surface Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway import surface
        run: |
          python -m scripts.ci.check_gateway_import_surface --verbose
          echo "Gateway import surface check passed"

  # ============================================================================
  # Gateway Public API Import Surface 检查
  # ============================================================================
  gateway-public-api-surface:
    name: Gateway Public API Import Surface Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway Public API import surface
        run: |
          python -m scripts.ci.check_gateway_public_api_import_surface --verbose
          echo "Gateway Public API import surface check passed"

      - name: Check Gateway Public API docs sync
        run: |
          python -m scripts.ci.check_gateway_public_api_docs_sync --verbose
          echo "Gateway Public API docs sync check passed"

  # ============================================================================
  # Gateway correlation_id 单一来源检查
  # ============================================================================
  gateway-correlation-id-single-source:
    name: Gateway correlation_id Single Source Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway correlation_id single source
        run: |
          python -m scripts.ci.check_gateway_correlation_id_single_source --verbose
          echo "Gateway correlation_id single source check passed"

  # ============================================================================
  # MCP JSON-RPC 错误码合约与文档同步检查
  # ============================================================================
  mcp-error-contract:
    name: MCP Error Contract Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check MCP JSON-RPC error contract
        run: |
          python -m scripts.ci.check_mcp_jsonrpc_error_contract --verbose
          echo "MCP JSON-RPC error contract check passed"

      - name: Check MCP JSON-RPC error docs sync
        run: |
          python -m scripts.ci.check_mcp_jsonrpc_error_docs_sync --verbose
          echo "MCP JSON-RPC error docs sync check passed"

      - name: Generate contract report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.check_mcp_jsonrpc_error_contract --json > artifacts/mcp_error_contract.json || true

      - name: Generate sync report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.check_mcp_jsonrpc_error_docs_sync --json > artifacts/mcp_error_docs_sync.json || true

      - name: Upload contract report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-error-contract
          path: artifacts/mcp_error_contract.json
          retention-days: 14

      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-error-docs-sync
          path: artifacts/mcp_error_docs_sync.json
          retention-days: 14

  # ============================================================================
  # 迭代文档检查（.iteration/ 链接 + SUPERSEDED 一致性）
  # ============================================================================
  iteration-docs-check:
    name: Iteration Docs Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check iteration docs consistency
        run: |
          python -m scripts.ci.check_no_iteration_links_in_docs --verbose
          echo "Iteration docs consistency check passed"

      - name: Check iteration evidence contract
        run: |
          python -m scripts.ci.check_iteration_evidence_contract --verbose
          echo "Iteration evidence contract check passed"

  # ============================================================================
  # CI 测试隔离检查
  # ============================================================================
  ci-test-isolation:
    name: CI Test Isolation Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check CI test isolation
        run: |
          echo "=== CI Test Isolation Check ==="
          echo "检查 tests/**/*.py 中的 sys.path 污染和顶层 CI 模块导入"
          echo ""
          python -m scripts.ci.check_ci_test_isolation --verbose
          echo "CI test isolation check passed"

      - name: Generate isolation report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.check_ci_test_isolation --json > artifacts/ci_test_isolation.json || true

      - name: Upload isolation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-isolation
          path: artifacts/ci_test_isolation.json
          retention-days: 14

  # ============================================================================
  # 迭代工具脚本测试（无需数据库）
  # ============================================================================
  iteration-tools-test:
    name: Iteration Tools Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run iteration tools tests
        run: |
          echo "=== Iteration Tools Tests ==="
          echo "运行 tests/iteration/ 目录下的测试（无需数据库）"
          echo ""
          pytest tests/iteration/ -q
          echo "Iteration tools tests passed"

      - name: Check iteration fixtures freshness
        run: |
          echo "=== Iteration Fixtures Freshness Check ==="
          make check-iteration-fixtures-freshness
          echo "Iteration fixtures freshness check passed"

  # ============================================================================
  # Workflow 合约校验
  # ============================================================================
  workflow-contract:
    name: Workflow Contract Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema pytest

      - name: Run CI script tests
        run: |
          echo "=== Running CI Script Tests ==="
          echo "运行 tests/ci/ 目录下的测试（跳过有导入问题的文件）"
          echo ""
          pytest tests/ci/ -q \
            --ignore=tests/ci/test_gateway_deps_db_allowlist.py \
            --ignore=tests/ci/test_gateway_deps_db_gate.py
          echo "CI script tests passed"

      - name: Validate workflow contract
        run: |
          echo "=== Workflow Contract Validation (Phase 1) ==="
          echo "校验范围: ci.yml + nightly.yml"
          echo "合约文件: scripts/ci/workflow_contract.v1.json"
          echo ""
          make validate-workflows-strict

      - name: Check workflow contract docs sync
        run: |
          echo "=== Workflow Contract Docs Sync Check ==="
          echo "检查合约定义与文档是否同步"
          echo ""
          make check-workflow-contract-docs-sync

      - name: Check workflow contract error types docs sync
        run: |
          echo "=== Workflow Contract Error Types Docs Sync Check ==="
          echo "检查第 13 章 Error Types 表格与代码常量是否同步"
          echo ""
          make check-workflow-contract-error-types-docs-sync

      - name: Check workflow contract version policy
        run: |
          echo "=== Workflow Contract Version Policy Check ==="
          echo "检查关键文件变更时版本是否正确更新"
          echo ""
          make check-workflow-contract-version-policy

      - name: Check workflow contract doc anchors
        run: |
          echo "=== Workflow Contract Doc Anchors Check ==="
          echo "检查错误消息中引用的文档锚点是否存在"
          echo ""
          make check-workflow-contract-doc-anchors

      - name: Check workflow contract internal consistency
        run: |
          echo "=== Workflow Contract Internal Consistency Check ==="
          echo "检查合约内部不变量（job_ids/job_names 长度、无重复等）"
          echo ""
          make check-workflow-contract-internal-consistency

      - name: Check workflow make targets consistency
        run: |
          echo "=== Workflow Make Targets Consistency Check ==="
          echo "检查 workflow 中 make targets 与 Makefile/Contract 一致性"
          echo ""
          make check-workflow-make-targets-consistency

      - name: Generate validation report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.validate_workflows --json > artifacts/workflow_contract_validation.json || true

      - name: Generate docs sync report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.check_workflow_contract_docs_sync --json > artifacts/workflow_contract_docs_sync.json || true

      - name: Generate drift report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.workflow_contract_drift_report --output artifacts/workflow_contract_drift.json || true

      - name: Generate drift report (Markdown)
        if: always()
        run: |
          mkdir -p artifacts
          python -m scripts.ci.workflow_contract_drift_report --markdown > artifacts/workflow_contract_drift.md || true

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-contract-validation
          path: artifacts/workflow_contract_validation.json
          retention-days: 14

      - name: Upload docs sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-contract-docs-sync
          path: artifacts/workflow_contract_docs_sync.json
          retention-days: 14

      - name: Upload drift report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-contract-drift
          path: |
            artifacts/workflow_contract_drift.json
            artifacts/workflow_contract_drift.md
          if-no-files-found: ignore
          retention-days: 14
