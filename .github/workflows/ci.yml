name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  # ============================================================================
  # 代码检查和测试
  # ============================================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: engram_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml', 'requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[full,dev]"

      - name: Run database migrations
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          ENGRAM_TESTING: "1"
        run: |
          # 执行 DDL 迁移 + 角色权限应用
          # 使用 tee 同时输出到终端和日志文件，便于调试
          # 2>&1: 合并 stderr 到 stdout，确保错误信息也被记录
          python -m engram.logbook.cli.db_migrate \
            --dsn "$POSTGRES_DSN" \
            --apply-roles \
            --apply-openmemory-grants \
            2>&1 | tee migration-output-${{ matrix.python-version }}.log
          # PIPESTATUS[0] 获取管道中第一个命令（Python 脚本）的退出码
          # 这是必要的，因为 tee 始终返回 0，会掩盖 Python 脚本的失败
          exit ${PIPESTATUS[0]}

      - name: Verify database migrations (strict mode)
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          ENGRAM_TESTING: "1"
        run: |
          # 严格模式验证：仅 FAIL 会导致非零退出码，阻断 CI（默认 fail_only 策略）
          # --verify-strict: 启用门禁检查，FAIL 项存在时返回非零退出码
          # 注意：WARN 不会导致失败，如需 WARN 也触发，需设置 gate_policy=fail_and_warn
          # 日志留存用于失败时的问题诊断
          python -m engram.logbook.cli.db_migrate \
            --dsn "$POSTGRES_DSN" \
            --verify \
            --verify-strict \
            2>&1 | tee verify-output-${{ matrix.python-version }}.log
          # 同样使用 PIPESTATUS[0] 传递正确的退出码
          exit ${PIPESTATUS[0]}

      - name: Run unit and integration tests
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_ADMIN_DSN: postgresql://postgres:postgres@localhost:5432/postgres
          PROJECT_KEY: test
        run: |
          pytest tests/gateway/ -v --junitxml=test-results-${{ matrix.python-version }}.xml

      - name: Run acceptance tests
        env:
          POSTGRES_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_DSN: postgresql://postgres:postgres@localhost:5432/engram_test
          TEST_PG_ADMIN_DSN: postgresql://postgres:postgres@localhost:5432/postgres
          PROJECT_KEY: test
        run: |
          pytest tests/acceptance/ -v --junitxml=acceptance-results-${{ matrix.python-version }}.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.python-version }}
          path: |
            test-results-${{ matrix.python-version }}.xml
            acceptance-results-${{ matrix.python-version }}.xml
          retention-days: 14

      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ matrix.python-version }}
          path: |
            migration-output-${{ matrix.python-version }}.log
            verify-output-${{ matrix.python-version }}.log
          retention-days: 14

  # ============================================================================
  # 代码质量检查
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff check (lint)
        run: ruff check src/ tests/

      - name: Run ruff format check
        run: ruff format --check src/ tests/

      - name: Run mypy (type check)
        run: mypy src/engram/

  # ============================================================================
  # .iteration/ 目录禁止提交检查
  # ============================================================================
  no-iteration-tracked:
    name: No .iteration/ Tracked Files
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check no .iteration files tracked
        run: |
          echo "Checking that .iteration/ is not tracked in git..."
          tracked=$(git ls-files .iteration 2>/dev/null || true)
          if [ -n "$tracked" ]; then
            echo "❌ ERROR: .iteration/ files are tracked in git!"
            echo "Tracked files:"
            echo "$tracked"
            echo ""
            echo "Please remove these files from git:"
            echo "  git rm -r --cached .iteration/"
            exit 1
          fi
          echo "✅ No .iteration/ files tracked in git"

  # ============================================================================
  # 环境变量一致性检查
  # ============================================================================
  env-var-consistency:
    name: Environment Variable Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check environment variable consistency
        run: |
          python scripts/ci/check_env_var_consistency.py --verbose
          echo "Environment variable consistency check passed"

  # ============================================================================
  # Schema 校验
  # ============================================================================
  schema-validate:
    name: Schema Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          # 验证 jsonschema 已安装
          python -c "import jsonschema; print(f'jsonschema {jsonschema.__version__} installed')"

      - name: Run schema validation
        run: |
          python scripts/validate_schemas.py --validate-fixtures --verbose --output schema-validation-results.json

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-validation-results
          path: schema-validation-results.json
          retention-days: 14

  # ============================================================================
  # Logbook 配置一致性检查
  # ============================================================================
  logbook-consistency:
    name: Logbook Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check logbook configuration consistency
        run: |
          python scripts/verify_logbook_consistency.py --verbose
          echo "Logbook consistency check passed"

  # ============================================================================
  # 迁移 Sanity 检查（SQL 文件存在性和基本语法）
  # ============================================================================
  migration-sanity:
    name: Migration Sanity Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check SQL migration files exist
        run: |
          echo "Checking SQL migration files..."
          required_files=(
            "sql/01_logbook_schema.sql"
            "sql/02_scm_migration.sql"
            "sql/04_roles_and_grants.sql"
            "sql/05_openmemory_roles_and_grants.sql"
          )
          missing=0
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "[ERROR] Missing: $f"
              missing=$((missing + 1))
            else
              echo "[OK] Found: $f"
            fi
          done
          if [ "$missing" -gt 0 ]; then
            echo "Missing $missing required migration files"
            exit 1
          fi
          echo "All required migration files present"

      - name: Check SQL syntax (basic validation)
        run: |
          echo "Checking SQL files for common syntax issues..."
          errors=0
          for f in sql/*.sql; do
            if [ -f "$f" ]; then
              # 检查文件非空
              if [ ! -s "$f" ]; then
                echo "[WARN] Empty file: $f"
              fi
              # 检查是否包含至少一个 SQL 语句关键字
              if ! grep -qiE '(CREATE|ALTER|INSERT|SELECT|DROP|GRANT|REVOKE)' "$f"; then
                echo "[WARN] No SQL statements found in: $f"
              else
                echo "[OK] $f"
              fi
            fi
          done
          echo "SQL sanity check completed"

  # ============================================================================
  # SQL 迁移安全性检查（高危语句检测）
  # ============================================================================
  sql-safety:
    name: SQL Migration Safety Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run SQL safety check
        run: |
          echo "=== SQL 迁移安全性检查 ==="
          echo ""
          echo "检查规则："
          echo "  - Denylist: 绝对禁止的危险语句（DROP TABLE 无 IF EXISTS, TRUNCATE 等）"
          echo "  - Allowlist: 需要 -- SAFE: 或 -- BREAKING: 标记的语句"
          echo ""
          python -m pytest tests/logbook/test_sql_migrations_safety.py -v --tb=short
          echo ""
          echo "SQL 迁移安全性检查通过"

  # ============================================================================
  # Gateway DI 边界检查
  # ============================================================================
  gateway-di-boundaries:
    name: Gateway DI Boundaries Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway DI boundaries
        run: |
          python scripts/ci/check_gateway_di_boundaries.py --verbose
          echo "Gateway DI boundaries check passed"

  # ============================================================================
  # SCM Sync 一致性检查
  # ============================================================================
  scm-sync-consistency:
    name: SCM Sync Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check SCM Sync consistency
        run: |
          python scripts/verify_scm_sync_consistency.py --verbose
          echo "SCM Sync consistency check passed"

  # ============================================================================
  # Gateway ErrorReason 使用规范检查
  # ============================================================================
  gateway-error-reason-usage:
    name: Gateway ErrorReason Usage Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Gateway ErrorReason usage
        run: |
          python scripts/ci/check_gateway_error_reason_usage.py --verbose
          echo "Gateway ErrorReason usage check passed"

  # ============================================================================
  # 迭代文档检查（.iteration/ 链接 + SUPERSEDED 一致性）
  # ============================================================================
  iteration-docs-check:
    name: Iteration Docs Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check iteration docs consistency
        run: |
          python scripts/ci/check_no_iteration_links_in_docs.py --verbose
          echo "Iteration docs consistency check passed"

  # ============================================================================
  # Workflow 合约校验
  # ============================================================================
  workflow-contract:
    name: Workflow Contract Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema pytest

      - name: Run CI script tests
        run: |
          echo "=== Running CI Script Tests ==="
          echo "运行 tests/ci/ 目录下的测试（跳过有导入问题的文件）"
          echo ""
          pytest tests/ci/ -q \
            --ignore=tests/ci/test_gateway_deps_db_allowlist.py \
            --ignore=tests/ci/test_gateway_deps_db_gate.py \
            --ignore=tests/ci/test_gateway_import_surface_gate.py \
            --ignore=tests/ci/test_strict_island_admission.py \
            --ignore=tests/ci/test_mypy_baseline_policy.py \
            --ignore=tests/ci/test_mypy_metrics.py
          echo "CI script tests passed"

      - name: Validate workflow contract
        run: |
          echo "=== Workflow Contract Validation (Phase 1) ==="
          echo "校验范围: ci.yml + nightly.yml"
          echo "合约文件: scripts/ci/workflow_contract.v1.json"
          echo ""
          python scripts/ci/validate_workflows.py
          echo "Workflow contract validation passed"

      - name: Check workflow contract docs sync
        run: |
          echo "=== Workflow Contract Docs Sync Check ==="
          echo "检查合约定义与文档是否同步"
          echo ""
          python scripts/ci/check_workflow_contract_docs_sync.py
          echo "Workflow contract docs sync check passed"

      - name: Generate validation report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python scripts/ci/validate_workflows.py --json > artifacts/workflow_contract_validation.json || true

      - name: Generate docs sync report (JSON)
        if: always()
        run: |
          mkdir -p artifacts
          python scripts/ci/check_workflow_contract_docs_sync.py --json > artifacts/workflow_contract_docs_sync.json || true

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-contract-validation
          path: artifacts/workflow_contract_validation.json
          retention-days: 14

      - name: Upload docs sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-contract-docs-sync
          path: artifacts/workflow_contract_docs_sync.json
          retention-days: 14
