# ==============================================================================
# Engram Release Workflow
# ==============================================================================
#
# è§¦å‘æ¡ä»¶: push tag (vX.Y.Z æ ¼å¼)
#
# ä¸»è¦åŠŸèƒ½:
#   1. Gate æ£€æŸ¥: verify-build + verify-unified VERIFY_FULL=1
#   2. Docker buildx build + push (å¯é…ç½®æ˜¯å¦æŽ¨é€åˆ° registry)
#   3. äº§å‡º digest æŠ¥å‘Šå¹¶ä½œä¸º artifact å­˜æ¡£
#
# é•œåƒåˆ—è¡¨:
#   - gateway
#   - worker
#   - openmemory
#   - openmemory_migrate
#   - dashboard
#
# ==============================================================================

name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # v1.0.0, v1.0.0-beta.1, v1.0.0-rc.1, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'æ‰‹åŠ¨æŒ‡å®š tag (ä¾‹å¦‚: v1.0.0)'
        required: false
        type: string
      push_images:
        description: 'æ˜¯å¦æŽ¨é€é•œåƒåˆ° registry'
        required: false
        default: false
        type: boolean
      skip_gate:
        description: 'è·³è¿‡ Gate æ£€æŸ¥ (ä»…è°ƒè¯•ç”¨)'
        required: false
        default: false
        type: boolean
      registry:
        description: 'Docker registry (é»˜è®¤ ghcr.io)'
        required: false
        default: 'ghcr.io'
        type: string

# å…¨å±€çŽ¯å¢ƒå˜é‡
env:
  COMPOSE_PROJECT_NAME: engram
  COMPOSE_FILE: docker-compose.unified.yml
  # æœåŠ¡è´¦å·å¯†ç  (CI æµ‹è¯•å›ºå®šå€¼)
  STEP1_MIGRATOR_PASSWORD: ci_migrator_pass_123
  STEP1_SVC_PASSWORD: ci_svc_pass_123
  OPENMEMORY_MIGRATOR_PASSWORD: ci_om_migrator_pass_123
  OPENMEMORY_SVC_PASSWORD: ci_om_svc_pass_123
  # PostgreSQL é…ç½®
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_DB: engram
  # é»˜è®¤ registry
  REGISTRY: ${{ github.event.inputs.registry || 'ghcr.io' }}
  IMAGE_PREFIX: ${{ github.event.inputs.registry || 'ghcr.io' }}/${{ github.repository_owner }}/engram

jobs:
  # ============================================================================
  # é˜¶æ®µ 1: Gate æ£€æŸ¥ (verify-build + verify-unified)
  # ============================================================================
  gate:
    name: Release Gate Check
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ github.event.inputs.skip_gate != 'true' }}

    outputs:
      version: ${{ steps.version.outputs.version }}
      version_short: ${{ steps.version.outputs.version_short }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # ç§»é™¤ v å‰ç¼€èŽ·å–çŸ­ç‰ˆæœ¬
          VERSION_SHORT="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_short=$VERSION_SHORT" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION (short: $VERSION_SHORT)"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-release-${{ hashFiles('apps/**/requirements*.txt', 'apps/**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-release-
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest psycopg[binary] httpx
          # Step1 dependencies
          cd apps/step1_logbook_postgres/scripts
          pip install -r requirements.txt
          pip install -e .
          # Gateway dependencies
          cd ../../../apps/step2_openmemory_gateway/gateway
          pip install -e '.[dev]'

      # ========================================================================
      # Gate Step 1: verify-build-static
      # ========================================================================
      - name: Verify build static
        run: |
          echo "::group::Static Build Checks"
          make verify-build-static
          echo "::endgroup::"

      # ========================================================================
      # Gate Step 2: verify-build (å®žé™… Docker æž„å»º)
      # ========================================================================
      - name: Verify build (Docker)
        run: |
          echo "::group::Docker Build Verification"
          make verify-build
          echo "::endgroup::"

      # ========================================================================
      # Gate Step 3: Deploy + verify-unified VERIFY_FULL=1
      # ========================================================================
      - name: Deploy unified stack
        run: |
          echo "::group::Deploy unified stack"
          make deploy
          echo "::endgroup::"
          
          echo "Waiting for services to stabilize..."
          sleep 15
          
          echo "::group::Service status"
          docker compose -p engram -f docker-compose.unified.yml ps
          echo "::endgroup::"

      - name: Verify unified stack (FULL mode)
        env:
          VERIFY_FULL: "1"
        run: |
          echo "::group::Unified Stack Verification (FULL)"
          mkdir -p .artifacts
          make verify-unified VERIFY_FULL=1 VERIFY_JSON_OUT=.artifacts/verify-results.json
          echo "::endgroup::"

      - name: Run Gateway integration tests
        env:
          RUN_INTEGRATION_TESTS: "1"
          HTTP_ONLY_MODE: "1"
        run: |
          echo "::group::Gateway Integration Tests"
          make test-gateway-integration
          echo "::endgroup::"

      - name: Upload gate verification results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-verification-results
          path: |
            .artifacts/verify-results.json
            .artifacts/test-results/
          retention-days: 30
          if-no-files-found: ignore

      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p .artifacts/gate-failure
          docker compose -p engram -f docker-compose.unified.yml config > .artifacts/gate-failure/compose-config.yml 2>&1 || true
          docker compose -p engram -f docker-compose.unified.yml ps > .artifacts/gate-failure/compose-ps.txt 2>&1 || true
          docker compose -p engram -f docker-compose.unified.yml logs --no-color --tail=500 > .artifacts/gate-failure/compose-logs.txt 2>&1 || true

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gate-failure-logs-${{ github.run_number }}
          path: .artifacts/gate-failure/
          retention-days: 14

  # ============================================================================
  # é˜¶æ®µ 2: Docker é•œåƒæž„å»º + Push + Digest æŠ¥å‘Š
  # ============================================================================
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [gate]
    # å³ä½¿ gate è¢«è·³è¿‡ä¹Ÿæ‰§è¡Œï¼ˆworkflow_dispatch skip_gate=true åœºæ™¯ï¼‰
    if: ${{ always() && (needs.gate.result == 'success' || needs.gate.result == 'skipped') }}

    permissions:
      contents: read
      packages: write

    outputs:
      digest_gateway: ${{ steps.build_gateway.outputs.digest }}
      digest_worker: ${{ steps.build_worker.outputs.digest }}
      digest_openmemory: ${{ steps.build_openmemory.outputs.digest }}
      digest_openmemory_migrate: ${{ steps.build_openmemory_migrate.outputs.digest }}
      digest_dashboard: ${{ steps.build_dashboard.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION_SHORT="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_short=$VERSION_SHORT" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        if: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========================================================================
      # Build: gateway
      # ========================================================================
      - name: Build gateway
        id: build_gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/step2_openmemory_gateway/gateway/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-gateway:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_PREFIX }}-gateway:${{ steps.version.outputs.version_short }}
            ${{ env.IMAGE_PREFIX }}-gateway:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Build: worker (åŒ Dockerfileï¼Œä¸åŒ command)
      # ========================================================================
      - name: Build worker
        id: build_worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/step2_openmemory_gateway/gateway/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-worker:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_PREFIX }}-worker:${{ steps.version.outputs.version_short }}
            ${{ env.IMAGE_PREFIX }}-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Build: openmemory
      # ========================================================================
      - name: Build openmemory
        id: build_openmemory
        uses: docker/build-push-action@v5
        with:
          context: ./libs/OpenMemory/packages/openmemory-js
          file: ./libs/OpenMemory/packages/openmemory-js/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-openmemory:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_PREFIX }}-openmemory:${{ steps.version.outputs.version_short }}
            ${{ env.IMAGE_PREFIX }}-openmemory:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Build: openmemory_migrate
      # ========================================================================
      - name: Build openmemory_migrate
        id: build_openmemory_migrate
        uses: docker/build-push-action@v5
        with:
          context: ./libs/OpenMemory/packages/openmemory-js
          file: ./libs/OpenMemory/packages/openmemory-js/Dockerfile
          target: builder
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-openmemory-migrate:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_PREFIX }}-openmemory-migrate:${{ steps.version.outputs.version_short }}
            ${{ env.IMAGE_PREFIX }}-openmemory-migrate:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # Build: dashboard (å¯é€‰ï¼Œä»…å½“ç›®å½•å­˜åœ¨æ—¶æž„å»º)
      # ========================================================================
      - name: Check dashboard source exists
        id: check_dashboard
        run: |
          if [ -f "libs/OpenMemory/dashboard/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Dashboard source not found, skipping dashboard build"
          fi

      - name: Build dashboard
        id: build_dashboard
        if: steps.check_dashboard.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./libs/OpenMemory/dashboard
          file: ./libs/OpenMemory/dashboard/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }}
          tags: |
            ${{ env.IMAGE_PREFIX }}-dashboard:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_PREFIX }}-dashboard:${{ steps.version.outputs.version_short }}
            ${{ env.IMAGE_PREFIX }}-dashboard:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========================================================================
      # ç”Ÿæˆ Digest æŠ¥å‘Š
      # ========================================================================
      - name: Set up Python for audit
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate artifact audit report
        id: audit
        run: |
          mkdir -p .artifacts
          
          # è¿è¡Œ openmemory_artifact_audit.py ç”ŸæˆæŠ¥å‘Š
          python scripts/openmemory_artifact_audit.py \
            --compose-project engram \
            --output .artifacts/openmemory-artifact-audit.json
          
          # åŒæ—¶è¾“å‡º JSON åˆ° stdout ä¾›æ—¥å¿—æŸ¥çœ‹
          echo "=== Artifact Audit Report ==="
          python scripts/openmemory_artifact_audit.py --json
          
          # ç”Ÿæˆå®Œæ•´çš„ release digest æŠ¥å‘Š
          cat > .artifacts/release-digest-report.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "version_short": "${{ steps.version.outputs.version_short }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "pushed_to_registry": ${{ github.event.inputs.push_images == 'true' || github.event_name == 'push' }},
            "registry": "${{ env.REGISTRY }}",
            "images": {
              "gateway": {
                "tag": "${{ env.IMAGE_PREFIX }}-gateway:${{ steps.version.outputs.version }}",
                "digest": "${{ steps.build_gateway.outputs.digest }}"
              },
              "worker": {
                "tag": "${{ env.IMAGE_PREFIX }}-worker:${{ steps.version.outputs.version }}",
                "digest": "${{ steps.build_worker.outputs.digest }}"
              },
              "openmemory": {
                "tag": "${{ env.IMAGE_PREFIX }}-openmemory:${{ steps.version.outputs.version }}",
                "digest": "${{ steps.build_openmemory.outputs.digest }}"
              },
              "openmemory_migrate": {
                "tag": "${{ env.IMAGE_PREFIX }}-openmemory-migrate:${{ steps.version.outputs.version }}",
                "digest": "${{ steps.build_openmemory_migrate.outputs.digest }}"
              },
              "dashboard": {
                "tag": "${{ env.IMAGE_PREFIX }}-dashboard:${{ steps.version.outputs.version }}",
                "digest": "${{ steps.build_dashboard.outputs.digest }}",
                "skipped": ${{ steps.check_dashboard.outputs.exists != 'true' }}
              }
            }
          }
          EOF
          
          echo "=== Release Digest Report ==="
          cat .artifacts/release-digest-report.json

      - name: Upload digest report artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-digest-report-${{ steps.version.outputs.version }}
          path: |
            .artifacts/release-digest-report.json
            .artifacts/openmemory-artifact-audit.json
          retention-days: 90

  # ============================================================================
  # é˜¶æ®µ 3: Release Summary
  # ============================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [gate, build]
    if: always()

    steps:
      - name: Download digest report
        uses: actions/download-artifact@v4
        with:
          name: release-digest-report-${{ needs.gate.outputs.version || github.event.inputs.tag || github.ref_name }}
          path: .artifacts
        continue-on-error: true

      - name: Generate Release Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç‰ˆæœ¬ä¿¡æ¯
          VERSION="${{ needs.gate.outputs.version || github.event.inputs.tag || github.ref_name }}"
          echo "### Version: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Gate çŠ¶æ€
          echo "### Gate Check" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_gate }}" == "true" ]; then
            echo "| Gate | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Gate | ${{ needs.gate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build çŠ¶æ€
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| gateway | ${{ needs.build.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| worker | ${{ needs.build.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| openmemory | ${{ needs.build.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| openmemory_migrate | ${{ needs.build.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dashboard | ${{ needs.build.result == 'success' && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Push çŠ¶æ€
          if [ "${{ github.event.inputs.push_images }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
            echo "### Registry Push" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Images pushed to \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Registry Push" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Images **not pushed** (build only)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Digest æŠ¥å‘Šé“¾æŽ¥
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ [Digest Report](../actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤º digest è¯¦æƒ…ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -f ".artifacts/release-digest-report.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Image Digests" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat .artifacts/release-digest-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
