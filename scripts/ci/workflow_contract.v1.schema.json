{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "workflow_contract.v1.schema.json",
  "title": "Workflow Contract Schema",
  "description": "JSON Schema for Engram CI/CD workflow contract validation",
  "type": "object",
  "required": ["version", "ci", "nightly", "make", "frozen_step_text", "frozen_job_names"],
  "properties": {
    "$schema": {
      "type": "string",
      "pattern": "^workflow_contract\\.v1\\.schema\\.json$",
      "description": "Reference to this schema file (must be workflow_contract.v1.schema.json)"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "description": "Contract version in semver format (e.g., 1.4.0)"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Human-readable description of the contract (10-500 characters)"
    },
    "last_updated": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
      "description": "Last update date in YYYY-MM-DD format"
    },
    "ci": {
      "$ref": "#/definitions/ci_workflow_definition",
      "description": "CI workflow definition (required)"
    },
    "nightly": {
      "$ref": "#/definitions/nightly_workflow_definition",
      "description": "Nightly workflow definition (required)"
    },
    "release": {
      "$ref": "#/definitions/workflow_definition",
      "description": "Release workflow definition (optional, Phase 2)"
    },
    "make": {
      "$ref": "#/definitions/make_definition",
      "description": "Makefile targets contract"
    },
    "frozen_step_text": {
      "$ref": "#/definitions/frozen_step_text_definition",
      "description": "Frozen step names that must match exactly"
    },
    "frozen_job_names": {
      "$ref": "#/definitions/frozen_job_names_definition",
      "description": "Frozen job names that must match exactly"
    }
  },
  "patternProperties": {
    "^_changelog_v[0-9]+\\.[0-9]+\\.[0-9]+$": {
      "type": "string",
      "minLength": 1,
      "description": "Changelog entry for a specific version (e.g., _changelog_v2.5.0)"
    },
    "^_[a-z][a-z0-9_]*$": {
      "type": "string",
      "description": "Internal comment or metadata field (must start with underscore)"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "workflow_definition": {
      "type": "object",
      "required": ["file"],
      "properties": {
        "file": {
          "type": "string",
          "pattern": "^\\.github/workflows/[a-z][a-z0-9_-]*\\.yml$",
          "description": "Path to the workflow file (must match .github/workflows/<name>.yml)"
        },
        "detect_changes": {
          "type": "object",
          "properties": {
            "outputs": {
              "type": "array",
              "items": { "type": "string", "pattern": "^[a-z][a-z0-9_-]*$" },
              "description": "List of output names from change detection"
            }
          },
          "patternProperties": {
            "^_[a-z][a-z0-9_]*$": { "type": "string" }
          },
          "additionalProperties": false
        },
        "labels": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9:_-]*$" },
          "description": "PR labels used by this workflow (lowercase with optional colon)"
        },
        "job_ids": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_-]*$" },
          "minItems": 1,
          "description": "List of job IDs in this workflow (lowercase kebab-case)"
        },
        "job_names": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "List of job display names (position-matched to job_ids)"
        },
        "required_jobs": {
          "type": "array",
          "items": { "$ref": "#/definitions/required_job" },
          "description": "Jobs that must exist with specific requirements"
        },
        "required_env_vars": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[A-Z][A-Z0-9_]*$" },
          "description": "Environment variables required at workflow level (UPPER_SNAKE_CASE)"
        },
        "artifact_archive": {
          "$ref": "#/definitions/artifact_archive_contract",
          "description": "Artifact archive contract for this workflow"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment field starting with underscore"
        }
      },
      "additionalProperties": false
    },
    "ci_workflow_definition": {
      "description": "CI workflow definition with stricter requirements",
      "allOf": [
        { "$ref": "#/definitions/workflow_definition" },
        {
          "type": "object",
          "required": ["file", "job_ids", "job_names", "required_jobs"],
          "properties": {
            "file": {
              "type": "string",
              "pattern": "^\\.github/workflows/ci\\.yml$",
              "description": "CI workflow file path (must be .github/workflows/ci.yml)"
            },
            "labels": {
              "type": "array",
              "description": "PR labels for CI workflow (e.g., openmemory:freeze-override)"
            },
            "detect_changes": {
              "type": "object",
              "description": "Change detection configuration (optional for CI)"
            },
            "artifact_archive": {
              "$ref": "#/definitions/artifact_archive_contract",
              "description": "Artifact archive contract (recommended for CI)"
            }
          }
        }
      ]
    },
    "nightly_workflow_definition": {
      "description": "Nightly workflow definition with stricter requirements",
      "allOf": [
        { "$ref": "#/definitions/workflow_definition" },
        {
          "type": "object",
          "required": ["file", "job_ids", "job_names", "required_jobs", "required_env_vars"],
          "properties": {
            "file": {
              "type": "string",
              "pattern": "^\\.github/workflows/nightly\\.yml$",
              "description": "Nightly workflow file path (must be .github/workflows/nightly.yml)"
            },
            "required_env_vars": {
              "type": "array",
              "minItems": 1,
              "description": "Environment variables required for nightly (must define at least one)"
            }
          }
        }
      ]
    },
    "required_job": {
      "type": "object",
      "required": ["id", "name", "required_steps"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Job ID (must match jobs.<id> in workflow, lowercase kebab-case)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Expected job display name (required)"
        },
        "required_steps": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "description": "Step names that must exist in this job (at least one required)"
        },
        "required_outputs": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_-]*$" },
          "description": "Output names that must be defined (lowercase)"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment field starting with underscore"
        }
      },
      "additionalProperties": false
    },
    "make_definition": {
      "type": "object",
      "required": ["targets_required"],
      "properties": {
        "targets_required": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9_-]*$" },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Makefile targets that must exist (lowercase, kebab-case or snake_case)"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment field starting with underscore"
        }
      },
      "additionalProperties": false
    },
    "frozen_step_text_definition": {
      "type": "object",
      "required": ["allowlist"],
      "properties": {
        "allowlist": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Step names that are frozen and must match exactly (no duplicates)"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment or process documentation field"
        }
      },
      "additionalProperties": false
    },
    "frozen_job_names_definition": {
      "type": "object",
      "required": ["allowlist"],
      "properties": {
        "allowlist": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "uniqueItems": true,
          "description": "Job names that are frozen and must match exactly (no duplicates)"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment or process documentation field"
        }
      },
      "additionalProperties": false
    },
    "artifact_archive_contract": {
      "type": "object",
      "description": "Artifact archive contract for validating upload-artifact steps",
      "properties": {
        "required_artifact_paths": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "List of artifact paths that must be uploaded (supports glob patterns)"
        },
        "artifact_step_names": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Optional: limit validation to steps with these names"
        }
      },
      "patternProperties": {
        "^_[a-z][a-z0-9_]*$": {
          "type": "string",
          "description": "Comment field starting with underscore"
        }
      },
      "additionalProperties": false
    }
  }
}
