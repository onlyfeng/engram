# Iteration 15 Regression - CI 流水线验证记录

## 执行信息

| 项目 | 值 |
|------|-----|
| **执行日期** | 2026-02-03 |
| **执行环境** | darwin 24.6.0 (x86_64) |
| **Python 版本** | 3.13.2 |
| **pytest 版本** | 9.0.2 |
| **执行者** | Cursor Agent |
| **CI 运行 ID** | - |
| **Commit** | 1c9f7b4 |

---

## 执行结果总览

| 序号 | 测试阶段 | 命令 | 状态 | 详情 |
|------|----------|------|------|------|
| 1 | 完整 CI 门禁 | `make ci` | ✅ PASS | 全部门禁通过（含 iteration fixtures freshness） |
| 2 | Gateway 测试 | `pytest tests/gateway/ -q` | ✅ PASS | 1105 passed, 206 skipped, 2 warnings |
| 3 | Acceptance 测试 | `pytest tests/acceptance/ -q` | ✅ PASS | 132 passed, 48 skipped |

**状态图例**：
- ✅ PASS - 全部通过
- ⚠️ PARTIAL - 部分通过（存在失败但非阻断）
- ❌ FAIL - 存在阻断性失败
- ⏳ 待执行 - 尚未执行
- ⏭️ N/A - 未配置/无需执行

---

## 详细执行记录

### 1. 完整 CI 门禁

**命令**: `make ci`

**状态**: ✅ PASS

**摘要**: 全部门禁通过（含格式、mypy、schema、workflow 合约、iteration fixtures freshness）。

---

### 2. Gateway 测试

**命令**: `pytest tests/gateway/ -q`

**状态**: ✅ PASS（1105 passed, 206 skipped）

**摘要**: 2 条告警（deprecated/unknown mark），不阻断。

---

### 3. Acceptance 测试

**命令**: `pytest tests/acceptance/ -q`

**状态**: ✅ PASS（132 passed, 48 skipped）

---

## 结论

**总体结果**：✅ PASS

**修复文件清单/变更摘要**：
- 格式与 lint 修复：`tests/iteration/test_rerun_advice_cli.py`、`tests/ci/test_workflow_contract_docs_generated_blocks.py`、`tests/ci/test_workflow_contract_error_types_docs_sync.py`、`tests/iteration/test_record_iteration_evidence.py`
- Gateway 异常兜底：`src/engram/gateway/routes.py`
- Workflow 合约错误类型文档补全：`docs/ci_nightly_workflow_refactor/contract.md`
- 迭代 fixtures 刷新：`tests/iteration/fixtures/...`

---

## 下一步行动

### 已完成
1. 执行 `make ci` / `pytest tests/gateway/ -q` / `pytest tests/acceptance/ -q`
2. 生成并同步 Iteration 15 证据与回归文档受控区块

### 验证命令（如需复跑）

```bash
make ci && pytest tests/gateway/ -q && pytest tests/acceptance/ -q
```

## 最小门禁命令块

> **说明**：此区块由脚本自动生成和更新。

<!-- BEGIN GENERATED: min_gate_block profile=full -->

## 最小门禁命令块

<!-- AUTO-GENERATED BY render_min_gate_block.py -->

> **Iteration 15** - 完整 CI 门禁（make ci）
>
> 此段落由脚本自动生成：`python scripts/iteration/render_min_gate_block.py 15 --profile full`

### 命令表格

| 序号 | 检查项 | 命令 | 通过标准 |
|------|--------|------|----------|
| 1 | 代码风格检查 | `make lint` | 退出码 0 |
| 2 | 格式检查 | `make format-check` | 退出码 0 |
| 3 | mypy 类型检查 | `make typecheck` | 退出码 0 |
| 4 | JSON Schema 校验 | `make check-schemas` | 退出码 0 |
| 5 | 环境变量一致性检查 | `make check-env-consistency` | 退出码 0 |
| 6 | Logbook 配置一致性检查 | `make check-logbook-consistency` | 退出码 0 |
| 7 | SQL 迁移文件检查 | `make check-migration-sanity` | 退出码 0 |
| 8 | SCM Sync 一致性检查 | `make check-scm-sync-consistency` | 退出码 0 |
| 9 | Gateway ErrorReason 使用规范检查 | `make check-gateway-error-reason-usage` | 退出码 0 |
| 10 | Gateway Public API 导入表面检查 | `make check-gateway-public-api-surface` | 退出码 0 |
| 11 | Gateway Public API 文档同步检查 | `make check-gateway-public-api-docs-sync` | 退出码 0 |
| 12 | Gateway DI 边界检查 | `make check-gateway-di-boundaries` | 退出码 0 |
| 13 | Gateway 懒加载策略检查 | `make check-gateway-import-surface` | 退出码 0 |
| 14 | Gateway correlation_id 单一来源检查 | `make check-gateway-correlation-id-single-source` | 退出码 0 |
| 15 | 迭代文档规范检查 | `make check-iteration-docs` | 退出码 0 |
| 16 | Workflow 合约校验 | `make validate-workflows-strict` | 退出码 0 |
| 17 | Workflow 合约文档同步检查 | `make check-workflow-contract-docs-sync` | 退出码 0 |
| 18 | Workflow 合约版本策略检查 | `make check-workflow-contract-version-policy` | 退出码 0 |
| 19 | MCP 错误码合约检查 | `make check-mcp-error-contract` | 退出码 0 |
| 20 | MCP 错误码文档同步检查 | `make check-mcp-error-docs-sync` | 退出码 0 |

### 一键执行

```bash
# 一键运行所有门禁（需全部通过）
make lint && \
  make format-check && \
  make typecheck && \
  make check-schemas && \
  make check-env-consistency && \
  make check-logbook-consistency && \
  make check-migration-sanity && \
  make check-scm-sync-consistency && \
  make check-gateway-error-reason-usage && \
  make check-gateway-public-api-surface && \
  make check-gateway-public-api-docs-sync && \
  make check-gateway-di-boundaries && \
  make check-gateway-import-surface && \
  make check-gateway-correlation-id-single-source && \
  make check-iteration-docs && \
  make validate-workflows-strict && \
  make check-workflow-contract-docs-sync && \
  make check-workflow-contract-version-policy && \
  make check-mcp-error-contract && \
  make check-mcp-error-docs-sync
```

### 通过标准

**通过标准**：每个命令需满足对应的通过条件。

- `make lint` → 退出码 0
- `make format-check` → 退出码 0
- `make typecheck` → 退出码 0
- `make check-schemas` → 退出码 0
- `make check-env-consistency` → 退出码 0
- `make check-logbook-consistency` → 退出码 0
- `make check-migration-sanity` → 退出码 0
- `make check-scm-sync-consistency` → 退出码 0
- `make check-gateway-error-reason-usage` → 退出码 0
- `make check-gateway-public-api-surface` → 退出码 0
- `make check-gateway-public-api-docs-sync` → 退出码 0
- `make check-gateway-di-boundaries` → 退出码 0
- `make check-gateway-import-surface` → 退出码 0
- `make check-gateway-correlation-id-single-source` → 退出码 0
- `make check-iteration-docs` → 退出码 0
- `make validate-workflows-strict` → 退出码 0
- `make check-workflow-contract-docs-sync` → 退出码 0
- `make check-workflow-contract-version-policy` → 退出码 0
- `make check-mcp-error-contract` → 退出码 0
- `make check-mcp-error-docs-sync` → 退出码 0


<!-- END GENERATED: min_gate_block -->

---

## 验收证据

<!-- BEGIN GENERATED: evidence_snippet -->

## 验收证据

<!-- 此段落由脚本自动生成，请勿手动编辑 -->

| 项目 | 值 |
|------|-----|
| **证据文件** | [`iteration_15_evidence.json`](evidence/iteration_15_evidence.json) |
| **Schema 版本** | `iteration_evidence_v2.schema.json` |
| **记录时间** | 2026-02-03T07:04:29Z |
| **Commit SHA** | `1c9f7b4` |

### 门禁命令执行摘要

> 以下表格由脚本从证据文件自动渲染。

| 命令 | 结果 | 耗时 | 摘要 |
|------|------|------|------|
| `make ci` | ✅ PASS | - | passed |
| `pytest tests/gateway/ -q` | ✅ PASS | - | 1105 passed, 206 skipped |
| `pytest tests/acceptance/ -q` | ✅ PASS | - | 132 passed, 48 skipped |

### 整体验收结果

- **结果**: ✅ PASS


<!-- END GENERATED: evidence_snippet -->

> **重要**：证据文件应由脚本自动生成，禁止手工创建或修改 JSON 文件。

---

## 相关文档

- [Iteration 14 回归记录](iteration_14_regression.md)
- [验收测试矩阵](00_acceptance_matrix.md)

---

更新时间：2026-02-03
