# MCP 配置 SSOT 不变式

本文件描述 MCP 配置的 SSOT 规则与文档同步约束，避免配置漂移。

## SSOT 位置

- 权威配置示例：`configs/mcp/.mcp.json.example`
- 任何配置变更只允许修改 SSOT，然后通过脚本同步到文档。

## 受控块规则

文档中用于展示 MCP 配置的片段必须位于受控块内：

```
<!-- BEGIN GENERATED: mcp_config_snippet -->
<!-- AUTO-GENERATED BY render_mcp_config_snippet.py; DO NOT EDIT -->
```json
{ ... }
```
<!-- END GENERATED -->
```

禁止手工编辑受控块内容，统一使用 `make update-mcp-config-docs` 更新。

## 白名单文档

仅以下文档允许包含 `mcpServers` 配置代码块：

- `README.md`
- `docs/installation.md`
- `docs/gateway/02_mcp_integration_cursor.md`

其他文档若包含 `mcpServers` 代码块，将触发 `doc_mcp_block_forbidden`。

## 同步流程

1. 修改 SSOT：`configs/mcp/.mcp.json.example`
2. 更新文档：`make update-mcp-config-docs`
3. 校验一致性：`make check-mcp-config-docs-sync`

## 渲染策略

文档片段仅渲染 SSOT 中的 `mcpServers` 字段（忽略 `$schema` 与 `_comment`）。

## MCP Doctor 配置解析约定

- 默认读取 `.cursor/mcp.json`，若不存在则读取 `~/.cursor/mcp.json`。
- 可通过 `MCP_DOCTOR_CONFIG` 或 `scripts/ops/mcp_doctor.py --config` 指定配置路径。
- 默认 server 为 `engram`；若仅配置单个 server，则自动选取该 server。
- 多 server 场景需使用 `--server` 指定目标 server。
- 未发现配置或 `mcpServers` 为空时，`mcp_doctor` 输出 N/A 并以安全退出码结束。
- 若配置缺少 `type`/`url` 或字段格式非法，`mcp_doctor` 返回非 0 并提示修复建议。
- 最小连通性探测使用 `tools/list`（与 MCP 约定一致）。
