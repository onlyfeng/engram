# 旧组件命名治理规范

> 本文档定义组件旧命名的治理规则，区分**流程编号**与**组件旧命名**的写法差异，确保文档、代码、CLI 输出的一致性。

---

## 1. 禁止 Token（组件旧命名）

以下 token 模式 **禁止**用于指代组件：

**禁止模式**：`(?i)step[1-3](?!\s)` — 匹配任意大小写的 `step` 后紧跟数字 `1`/`2`/`3`，且后面**没有空格**的情况。

| 禁止模式 | 匹配示例 | 替代词 | 说明 |
|----------|----------|--------|------|
| `(?i)step[1-3](?!\s)` | `stepN`、`StepN`、`STEPN`（N=1,2,3，任意大小写） | 官方组件名（`logbook`/`gateway`/`seekdb` 及对应大小写形式） | 数字阶段命名，已废弃 |

**关键区分**：无空格的 `StepN` 格式是组件旧名，带空格的 `Step N` 格式是流程编号，两者语义不同。

---

## 2. 允许写法（流程编号）

当表示**流程编号**、**操作步骤**时，必须使用以下写法：

| 允许写法 | 语言 | 示例 |
|----------|------|------|
| `Step 1`、`Step 2`、`Step 3` | 英文 | "Step 1: Install dependencies" |
| `步骤 1`、`步骤 2`、`步骤 3` | 中文 | "步骤 1：安装依赖" |
| `step 1`、`step 2`、`step 3` | 英文小写 | "See step 1 above" |

> **为什么 `Step N`（带空格）不会与组件旧名混淆？**
>
> 1. **语法结构不同**：组件旧名是连写标识符（如 `step1_xxx`），流程编号是 "Step" + 空格 + 数字
> 2. **正则模式精确区分**：禁止模式 `(?i)step[1-3](?!\s)` 使用负向前瞻 `(?!\s)` 明确排除后跟空格的情况
> 3. **语义场景明确**：流程编号通常后跟冒号或换行，组件旧名通常后跟下划线或紧跟中文描述
> 4. **CI 检查不会误报**：带空格的 `Step 1` 不匹配禁止模式，不会触发 CI 告警

**禁止写法**：

| 禁止写法 | 问题 | 正确写法 |
|----------|------|----------|
| 无空格的 `StepN` 格式 | 与组件旧名混淆 | `Step N`（带空格） |
| `步骤N`（无空格） | 缺少空格，可读性差 | `步骤 N` |

> **注意**：禁止规则**仅针对无空格的 `StepN` 格式**（N=1,2,3）。带空格的 `Step N` 是标准流程编号写法，完全允许使用。

---

## 3. 组件称谓规范

### 3.1 官方组件名称

| 组件 | 官方名称 | 可用别名 | 禁止用法 |
|------|----------|----------|----------|
| 事实账本 | **Logbook** | - | 数字阶段命名（`stepN` 形式） |
| 记忆网关 | **Gateway** | Memory Gateway | 数字阶段命名（`stepN` 形式） |
| 检索索引 | **SeekDB** | Seek Index | 数字阶段命名（`stepN` 形式） |

### 3.2 文档首次出现规则

在文档中，组件名称**首次出现**应使用完整名称，后续使用简称：

| 组件 | 首次出现写法 | 后续写法 |
|------|-------------|----------|
| 记忆网关 | Memory Gateway（MCP 网关） | Gateway |
| 检索索引 | SeekDB（RAG 检索索引） | SeekDB 或 Seek |
| 事实账本 | Logbook（事实账本） | Logbook |

**示例**：

```markdown
本文档定义 Memory Gateway（MCP 网关）与 Logbook（事实账本）之间的边界。
Gateway 负责策略校验，Logbook 负责事件持久化。
```

---

## 4. 替换表与示例

### 4.1 通用替换表

| 旧写法（禁止） | 新写法（正确） | 适用场景 |
|---------------|---------------|----------|
| 数字阶段命名（`stepN` 形式） | `Logbook` / `Gateway` / `SeekDB` | 组件称谓 |
| 历史目录路径（数字阶段命名） | `logbook_postgres` 等官方目录名 | 目录名/模块名 |
| 历史 Python 模块（数字阶段命名） | `engram_logbook` 等官方模块 | Python 模块 |
| 历史环境变量（数字阶段命名） | `ENGRAM_LOGBOOK_CONFIG` 等官方变量 | 环境变量 |
| 无空格的流程编号 | `Step 1: 安装` 或 `步骤 1：安装` | 流程编号 |

### 4.2 Markdown 标题示例

```markdown
<!-- 正确写法：组件名称 -->
## Logbook 部署指南
## Gateway 配置说明
### 1. Logbook 环境准备

<!-- 正确写法：流程编号 -->
## Step 1: 环境准备
## Step 2: 安装依赖
### 步骤 1：配置数据库
```

### 4.3 CLI help 示例

```python
# 正确写法
parser.add_argument('--logbook-config', help='Logbook 配置文件路径')
```

```bash
# 正确写法
Usage: engram logbook [OPTIONS]
  Logbook 事实账本管理命令
```

### 4.4 Schema description 示例

```sql
-- 正确写法
COMMENT ON TABLE logbook.events IS 'Logbook 事件表';
COMMENT ON COLUMN logbook.events.id IS 'Logbook 事件 ID';
```

### 4.5 代码注释示例

```python
# 正确写法（流程编号带空格）
# Step 1: 初始化数据库连接
# Step 2: 执行查询
# Step 3: 返回结果

# 或使用中文
# 步骤 1：初始化数据库连接
# 步骤 2：执行查询
# 步骤 3：返回结果
```

```python
# 正确写法（组件称谓）
# 调用 Logbook 的 API
# 从 Gateway 获取配置
```

---

## 5. CI 检查规则

### 5.1 禁止词正则

```bash
# 检查组件旧命名（无空格的 StepN 格式，N=1,2,3）
rg -iP '(?i)step[1-3](?!\s)' \
  --type-add 'code:*.{py,js,ts,go,rs,yml,yaml,toml,json,md,sh,sql}' -t code
```

### 5.2 流程编号格式检查

```bash
# 检查缺少空格的流程编号（流程编号必须带空格：Step N 而非 StepN）
rg -iP 'Step[1-3]:' \
  --type-add 'doc:*.{md,rst,txt}' -t doc
```

### 5.3 允许的例外

以下场景可豁免禁止词检查：

| 场景 | 示例 | 原因 |
|------|------|------|
| 历史引用 | "原数字阶段命名现更名为 Logbook" | 迁移文档需要说明历史 |
| 本文档 | 本文件 `legacy_naming_governance.md` | 定义禁止词本身 |
| 测试用例 | 测试禁止词检测功能 | 验证 CI 检查有效性 |

---

## 6. 检查清单

在提交代码或文档前，请检查：

- [ ] 组件名称使用 `Logbook`/`Gateway`/`SeekDB`，而非旧组件编号命名
- [ ] 流程编号使用 `Step 1`（带空格）或 `步骤 1`，而非无空格格式
- [ ] 目录名/模块名使用新命名（如 `logbook_postgres`）
- [ ] 环境变量使用新命名（如 `ENGRAM_LOGBOOK_CONFIG`）
- [ ] CLI 帮助文本使用新命名
- [ ] SQL 注释使用新命名
- [ ] 代码注释中的组件称谓使用新命名

---

## 7. 常见误报与修复示例

CI 检查有时会产生误报（流程编号被误判为组件旧名），以下是常见场景和修复方式：

### 7.1 误报场景

| 原文 | 是否误报 | 修复方式 |
|------|----------|----------|
| 无空格的流程编号（如 `StepN:`） | 是（流程编号） | 添加空格（`Step N:`） |
| `步骤N：`（无空格） | 否（格式问题） | `步骤 N：` |
| 数字阶段命名 + 功能描述 | 否（组件旧名） | 替换为正式组件名 |

### 7.2 修复示例

**流程编号修复（误报）**：

```diff
- StepN: 安装依赖    # 无空格的流程编号（N 为数字）
+ Step N: 安装依赖   # 正确：带空格

- 参见 stepN 中的说明
+ 参见 step N 中的说明
```

**组件旧名修复（真阳性）**：

```diff
- <数字阶段命名> 索引一致性检查
+ SeekDB 索引一致性检查

- <数字阶段命名> 事件日志
+ Logbook 事件日志

- <历史环境变量（数字阶段命名）>
+ LOGBOOK_CONFIG
```

### 7.3 快速判断规则

1. **后跟冒号或数字** → 大概率是流程编号 → 加空格修复
2. **后跟中文/功能描述** → 大概率是组件旧名 → 替换为正式组件名
3. **全大写** → 通常是环境变量或常量 → 替换为新命名

---

## 8. Baseline 更新红线

### 8.1 什么是 Baseline

CI 检查中的 baseline 文件记录了当前存量的禁止词数量，用于：
- 防止新代码引入更多禁止词
- 追踪清理进度

### 8.2 更新红线规则

| PR 类型 | 允许修改 baseline | 说明 |
|---------|-------------------|------|
| 功能开发 PR | **禁止** | 不允许新增禁止词，也不允许修改 baseline |
| Bug 修复 PR | **禁止** | 同上 |
| 文档 PR | **禁止** | 同上 |
| **清理专项 PR** | **允许** | 专门用于清理存量禁止词的 PR |
| **重命名迁移 PR** | **允许** | 大规模重命名（如目录重命名）的专项 PR |

### 8.3 清理专项 PR 要求

清理专项 PR 需满足：

1. **PR 标题前缀**：`[Legacy-Cleanup]` 或 `[Naming-Migration]`
2. **PR 描述**：明确列出清理范围和数量变化
3. **审批要求**：需要 CODEOWNERS 审批
4. **单一职责**：仅包含命名清理，不混入功能变更

**示例 PR 标题**：

```
[Legacy-Cleanup] 清理 docs/ 目录中的数字阶段命名
[Naming-Migration] 重命名历史目录为官方组件命名
```

### 8.4 违规处理

- 普通 PR 修改 baseline → CI 失败，要求移除 baseline 修改
- 新代码引入禁止词 → CI 失败，要求修复后重新提交

---

## 9. 参考文档

- [命名约束文档](./naming.md) - 完整的命名规范
- [ADR: SeekDB Schema 与 Role 命名统一](./adr_seekdb_schema_role_naming.md) - SeekDB 命名决策
